---
title: "ADHD_Control_Markdown"
author: "Daniel Newman"
output:
  html_document:
    fig_width: 8
    keep_md: yes
  word_document: default
---


```{r Load and Pre-Process the single trial Data, echo=FALSE, include=FALSE}

####Which computer/directory is this being run on?
location<-"Monash"
# location<-"DansLaptop"

if (location=="Monash") {
    setwd(("C:/GitHub/ADHDvsControls/Analyses Scripts_R"))
} else if (location=="DansLaptop") {
    setwd(("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_R"))
} else setwd(("~"))



### Install/load required packages
#List of R packages required for this analysis:
required_packages <- c("aod", "psych", "ggplot2", "tidyr", "stringr", "lubridate", "readxl","knitr",
                       "readr", "rmarkdown", "png", "lme4", "ez", "multcomp","zoo", "dplyr")
#Install required_packages:
new.packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
#Load required_packages:
lapply(required_packages, require, character.only = TRUE)






###### Import single trial data:
if (location=="Monash") {
data <- read.csv("C:/GitHub/ADHDvsControls/Analyses Scripts_Matlab/master_matrix_R.csv", header=FALSE)
} else if (location=="DansLaptop") {
data <- read.csv("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_Matlab/master_matrix_R.csv", header=FALSE)
} else setwd(("~"))
#Import IDs:
if (location=="Monash") {
ID <- read.table("C:/GitHub/ADHDvsControls/Analyses Scripts_Matlab/ID_vector.csv", quote="\"")
} else if (location=="DansLaptop") {
ID <- read.table("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_Matlab/ID_vector.csv", quote="\"")
} else setwd(("~"))

data$ID<-data[,1]
#Replace the participant numbers with IDs:
data[,1]<-ID[,1]
#Remove the seperate ID vector now it has been included into data dataframe
rm(ID)
drops <- c("ID")
data<-data[,!(names(data) %in% drops)]



###### Import data_ParticipantLevel:
if (location=="Monash") {
participant_level <- read.csv("C:/GitHub/ADHDvsControls/Analyses Scripts_Matlab/participant_level_matrix.csv", header=FALSE)
} else if (location=="DansLaptop") {
participant_level <- read.csv("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_Matlab/participant_level_matrix.csv", header=FALSE)
} else setwd(("~"))
#remove the RT measures that were calculated from ERP script - better to extract/collapse RT from the single-trial data so RT trials are not influenced by EEG artifacts
participant_level<-participant_level[,-c(1:4)]

#Import IDs:
if (location=="Monash") {
ID <- read.table("C:/GitHub/ADHDvsControls/Analyses Scripts_Matlab/IDs.csv", quote="\"")
} else if (location=="DansLaptop") {
ID <- read.csv("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_Matlab/IDs.csv", header=F)
} else setwd(("~"))
ID<-plyr::rename(ID,c("V1"="ID"))
participant_level$ID<-ID$ID
rm(ID)
# drops <- c("ID")
# participant_level<-participant_level[,!(names(participant_level) %in% drops)]

#import demographic data
if (location=="Monash") {
Demographics<-read.csv("C:/GitHub/ADHDvsControls/Analyses Scripts_R/ADHD_Control_Demographics_etc.csv", header=T)
} else if (location=="DansLaptop") {
Demographics<-read.csv("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_R/ADHD_Control_Demographics_etc.csv", header=T)
} else setwd(("~"))

#Remove all the previous Demographic measures ("_A") 
#we are only interested in the Demographic measures taken 
#when the RT and EEG data was collected ("_B")
Demographics <- Demographics %>% select(-ends_with("_A"))

#Rename data columns:
data<- data %>% #Rename data columns:
    rename(., 
            ID=V1,
            Group=V2,
            TotalTrialNumber=V3,
            Trial=V4,
            ITI=V5,
            Hemifield=V6,
            Accuracy=V7,
            RT=V8,
            Blinkneg500to0=V9,
            Blinkneg100_100PR=V10,
            Blinkneg100_450=V11,
            LeftFixBreakneg500_0=V12,
            LeftFixBreakneg100_100PR=V13,
            LeftFixBreakneg100_450=V14,
            RightFixBreakneg500_0=V15,
           RightFixBreakneg100_100PR=V16,
           RightFixBreakneg100_450=V17,
           BothFixBreakneg500_0=V18,
           BothFixBreakneg100_100PR=V19,
           BothFixBreakneg100_450=V20,
           Art_neg500_0=V21,
           Art_neg100_100PR=V22,
		   BLANK=V23,
		   RejectedTrial=V24,
		   Art_neg100_450=V25,
		   PreAlphaPowerLH=V26,
		   PreAlphaPowerRH=V27,
		   PreAlphaAsym=V28,
		   PrePupilDiameter=V29,
		   N2c_GA=V30,
		   N2i_GA=V31,
		   RespLockedCPPSlope=V32,
		   StimLockedCPPSlope=V33,
		   N2cPeakLatency=V34,
		   CPPHalfPeakLatency=V35,
		   N2c_PA=V36,
		   N2i_PA=V37,
		   PostAlphaPowerLH=V38,
		   PostAlphaPowerRH=V39) %>% #next make the required columns into factors:
            mutate_each_(funs(factor), c("Group", "ITI", "Hemifield", "Accuracy")) %>% #next re-class required vectors into Logicals:
            mutate_at(vars(starts_with("Art_")), funs(as.logical)) %>% 
            mutate_at(vars(contains("FixBreak")), funs(as.logical)) %>% 
            mutate_at(vars(contains("Blink")), funs(as.logical)) %>% 
            mutate_at(vars(starts_with("RejectedTrial")), funs(as.logical)) %>%#next Rename factor Levels:
            mutate(Hemifield = ifelse(Hemifield==1, "Left", "Right"), 
           Accuracy= ifelse(Accuracy==1, "Hit", "Miss"),
            Group = ifelse(Group==1, "ADHD", "Control"))
#NOTE: FOR N2c/i,  the _GA or _PA suffix indicates whether N2c/i is measured with a measurement window based
#on Grand average (GA) peak N2c/i latency,  or based on Participant level average (PA) peak N2c/i latency
             

#Order any ordinal factors (may have to do this the "trail" or later too) 
# by defult R uses polynomial contrasts for ordered factors, I'd rather treat light as unordered and to "treatment" contrasts, i.e. Low vs Med, Low vs High
data$ITI <- ordered(data$ITI)  


###############Data Cleaning For Single Trial Data######################
#Check number of Trials for each participant by running the function 'length', 
#on "data$RT" for each group, broken down by ID + Light
num_trials1 <- data %>% group_by(ID) %>% summarise( Trials = length(RT))
summary(num_trials1$Trials)


##################Accuracy ##########################
Accuracy_checker <- data %>% 
    group_by(ID) %>% 
    summarise(Hits  = sum(Accuracy=="Hit"),
              Misses = sum(Accuracy=="Miss"),
              LeftFixBreak = sum(LeftFixBreakneg100_100PR),
              RightFixBreak = sum(RightFixBreakneg100_100PR)) %>%
    mutate(Total=Hits+Misses,
           Accuracy_Total= (Hits/Total)*100,
           LeftFixBreak_percent = LeftFixBreak/(Total/2)*100,
           RightFixBreak_percent = RightFixBreak/(Total/2)*100) 
summary(Accuracy_checker$Accuracy_Total)


#Accuracy by Hemifield 
Accuracy_checker_Hemifield <- data %>% 
    group_by(ID, Hemifield) %>% 
    summarise(Hits  = sum(Accuracy=="Hit"),
              Misses = sum(Accuracy=="Miss")) %>%
    mutate(Total=Hits+Misses,
           Accuracy_Total= (Hits/Total)*100) %>%
    select(ID, Hemifield, Accuracy_Total) %>%
    spread(Hemifield, Accuracy_Total) %>%
    rename(Accuracy_Left = Left,
           Accuracy_Right = Right) %>%
    mutate(Accuracy_Asym =  #Negitive is better accuracy for left targets, positive is better accuracy for right targets:
               (Accuracy_Right-Accuracy_Left)/(Accuracy_Right+Accuracy_Left))


#merge Accuracy by hemifield in with in overall accuracy
Accuracy_checker <- merge(Accuracy_checker, Accuracy_checker_Hemifield, by.x = "ID", by.y = "ID")
rm(Accuracy_checker_Hemifield)

#Remove RejectedTrial (with eeg trigger conflicts)
#trials where RT longer than 1500ms (i.e. after target finished)
#or RT faster than 150ms (i.e. too fast must be false alarm)
data<-filter(data, RT<2000, RT>200, !-RejectedTrial)

############################################ Log transform:
data$log_RT<-log(data$RT) #log
data$sqrt_RT<-sqrt(data$RT)

ggplot(data, aes(RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)
ggplot(data, aes(log_RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)
ggplot(data, aes(sqrt_RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)

#####Z-score each participant's log_RT data ####
data$IDbyITIbyHemifield<-interaction(data$ID, data$ITI, data$Hemifield)
#calculate mean and sd 
m <- tapply(data$log_RT,data$IDbyITIbyHemifield,mean, na.rm = T)
s <- tapply(data$log_RT,data$IDbyITIbyHemifield,sd, na.rm = T)
#calculate log_RT.Z and save it inside data.frame
data$log_RT.Z <- (data$log_RT-m[data$IDbyITIbyHemifield])/s[data$IDbyITIbyHemifield]
#Remove trials where absolute log_RT.Z>3 (i.e. remove outlier RTs)
data<-data[!abs(data$log_RT.Z)>3,]

#Remove trials where absolute log_RT.Z>3 (i.e. remove outlier RTs)
data<-data[!abs(data$log_RT.Z)>3,] #this is for individual trial 



#plot again after outlier removal:
ggplot(data, aes(RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)
ggplot(data, aes(log_RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)
ggplot(data, aes(sqrt_RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)


#Calculate alpha desynchronisation by subtracting Pre-target Alpha from post target alpha
data$AlphaDesyncRH<-(data$PreAlphaPowerRH)-(data$PostAlphaPowerRH)
data$AlphaDesyncLH<-data$PreAlphaPowerLH-data$PostAlphaPowerLH

# Make PostAlpha contralateral (PostAlpha_c) and -Ipsilateral (PostAlpha_i) variables:
A<-data$Hemifield=="Left"
#Absolute post target alpha
data$PostAlpha_c[A]<-data$PostAlphaPowerRH[A]
data$PostAlpha_c[!A]<-data$PostAlphaPowerLH[!A]
data$PostAlpha_i[!A]<-data$PostAlphaPowerRH[!A]
data$PostAlpha_i[A]<-data$PostAlphaPowerLH[A]

#Post target Alpha desynchronisation 
data$AlphaDesync_c[A]<-data$AlphaDesyncRH[A]
data$AlphaDesync_c[!A]<-data$AlphaDesyncLH[!A]
data$AlphaDesync_i[!A]<-data$AlphaDesyncRH[!A]
data$AlphaDesync_i[A]<-data$AlphaDesyncLH[A]

rm(A)




#################################################################################################################################
#################################################################################################################################
#################################################################################################################################
#################################################################################################################################

#Rename participant_level columns of participant_level:
participant_level<- participant_level %>% #Rename data columns:
                        rename(., 
                                ValidPreAlphaTrials=V5,
                                ValidN2TrialsTrials=V6,
                                ValidCPPTrials=V7,
                                PreAlpha_LeftHemi=V8,
                                PreAlpha_RightHemi=V9,
                                N2c_LeftTarget_GA=V10,
                                N2c_RightTarget_GA=V11,
                                N2i_LeftTarget_GA=V12,
                                N2i_RightTarget_GA=V13,
                                AlphaDesync_LeftHemi_LeftTarget=V14,
                                AlphaDesync_LeftHemi_RightTarget=V15,
                                AlphaDesync_RightHemi_LeftTarget=V16,
                                AlphaDesync_RightHemi_RightTarget=V17,
                                CPPonset_LeftTarget=V18,
                                CPPonset_RightTarget=V19,
                                N2c_latency_LeftTarget=V20,
                                N2c_latency_RightTarget=V21,
                                N2i_latency_LeftTarget=V22,
                                N2i_latency_RightTarget=V23,
                                CPPslope_LeftTarget=V24,
                                CPPslope_RightTarget=V25,
							   FrontalNeg_slope_LeftTarget=V26,
							   FrontalNeg_slope_RightTarget=V27,
							   ADHD_Control=V28,
							   N2c_LeftTarget_PA=V29,
							   N2c_RightTarget_PA=V30,
							   N2i_LeftTarget_PA=V31, 
							   N2i_RightTarget_PA=V32) %>% ##next calculate the ERP asymmetry measures:
					    mutate(., 
                              N2c_Asym_GA = (N2c_LeftTarget_GA-N2c_RightTarget_GA)/(N2c_LeftTarget_GA+N2c_RightTarget_GA), 
                              N2i_Asym_GA = (N2i_LeftTarget_GA-N2i_RightTarget_GA)/(N2i_LeftTarget_GA+N2i_RightTarget_GA),
							  N2c_Asym_PA = (N2c_LeftTarget_PA-N2c_RightTarget_PA)/(N2c_LeftTarget_PA+N2c_RightTarget_PA), 
                              N2i_Asym_PA = (N2i_LeftTarget_PA-N2i_RightTarget_PA)/(N2i_LeftTarget_PA+N2i_RightTarget_PA),
							  CPPonset_Asym = (CPPonset_LeftTarget-CPPonset_RightTarget)/(CPPonset_LeftTarget+CPPonset_RightTarget),
                              CPPslope_Asym = (CPPslope_LeftTarget-CPPslope_RightTarget)/(CPPslope_LeftTarget+CPPslope_RightTarget),
							  N2c_latency_Asym = (N2c_latency_LeftTarget-N2c_latency_RightTarget)/(N2c_latency_LeftTarget+N2c_latency_RightTarget), 
                              N2i_latency_Asym =(N2i_latency_LeftTarget-N2i_latency_RightTarget)/(N2i_latency_LeftTarget+N2i_latency_RightTarget)) 
#NOTE: FOR N2c/i ,  the _GA or _PA suffix indicates whether N2c/i is measured with a measurement window based  
#on Grand average (GA) peak N2c/i latency ,  or based on Participant level average (PA) peak N2c/i latency

#Merge Demographics into participant_level:
participant_level <- merge(participant_level, Demographics, by.x = "ID", by.y = "ID")
rm(Demographics)

participant_level<- participant_level %>%
    					    mutate(., 
                              Group = ifelse(Group==1, "ADHD", "Control"),
							  Hand_SR_B= ifelse(Hand_SR_B==1, "Left", "Right"),
							  Gender= ifelse(Gender==1, "Male", "Female"),
							  DAT1_3UTR= ifelse(DAT1_3_Group==1, "non10repeat_homozygous", "10repeat_homozygous"),
							  DAT1_i8= ifelse(DAT1_i8_Group==1, "non6repeat_homozygous", "6repeat_homozygous")) %>%
                        mutate_each_(funs(factor), c("Group", "Gender", "Hand_SR_B", "DAT1_3_Group", "DAT1_i8_Group")) 

#Look at Column names:
colnames(participant_level)

#Rename the full scale IQ, Edinburgh Handedness scale, reading for simplicity 
participant_level$IQ<-participant_level$eFSIQ_B
participant_level$Handedness_Edinburgh<-participant_level$HQ_B
participant_level$Handedness_SelfReport<-participant_level$Hand_SR_B
participant_level$Reading <-participant_level$Read_Standard_B #WRAT Reading standard score (at time B)
participant_level$Age<-participant_level$Age_B

#add in accuracy
participant_level <- merge(participant_level, Accuracy_checker, by.x = "ID", by.y = "ID")


###Incorporate the demographic variables from participant_level into the single trial 'data' dataframe 
target<-select(participant_level, ID, IQ, Handedness_Edinburgh, Handedness_SelfReport, Reading, Age, Gender, DAT1_3UTR, DAT1_i8,
                      Accuracy_Asym, Accuracy_Total, LeftFixBreak_percent, RightFixBreak_percent)
data<-merge(data, target, by.x="ID", by.y = "ID")
rm(target)


#Collapse each participant's RT single trials to participant level
RT_collapsed<- data %>% 
            filter(!LeftFixBreakneg100_100PR, !RightFixBreakneg100_100PR) %>%
            group_by(ID, Hemifield) %>%
            summarise(RT=mean(RT)) %>% #next bring Target-Hemifield up into wide format:
            spread(Hemifield, RT) %>% #next rename
            rename(RT_Left=Left, RT_Right=Right) %>% # next Calculate RT asymmetry:
            mutate(RT_Asym=(RT_Left-RT_Right)/(RT_Left+RT_Right)) 
#Merge it in with the ERP measures
participant_level<-merge(participant_level, RT_collapsed, by.x = "ID", by.y = "ID") 


############## Participant exclusion ####################   
#Participant level
participant_level <- filter(participant_level, 
                            Handedness_SelfReport == "Left",
                            ValidCPPTrials > 50,
                            LeftFixBreak_percent <55,
                            RightFixBreak_percent <55,
                            ((Group=="ADHD" & CPRS_N_B >= 65) | (Group=="Control" & CPRS_N_B <= 60)))


######################################################################################

####Find outliers in the Participant level data (abs z-score >3)####
#################################################################
#Calculate Z scores inside measure_type type TO REMOVE OUTLIERS
#Z-score each participant's data inside measure_type ####
#calculate mean and sd 

#Transform it to long format
participant_level_long<-participant_level %>%
                    select(ID, Group, RT_Left, RT_Right, RT_Asym, 
                           PreAlpha_LeftHemi:N2i_latency_Asym) %>%
                    gather(measure_type, data, -ID, -Group) %>%
                    na.omit() %>%
                    mutate(Group_by_measure_type = interaction(.$Group, .$measure_type))  %>%
                    na.omit() 
    

m <- tapply(participant_level_long$data, participant_level_long$Group_by_measure_type, mean, na.rm = T)
s <- tapply(participant_level_long$data, participant_level_long$Group_by_measure_type, sd, na.rm = T)
 
#calculate data.Z and save it inside participant_level_long
participant_level_long$data.Z <- (participant_level_long$data- m[participant_level_long$Group_by_measure_type])/s[participant_level_long$Group_by_measure_type]

participant_level_long<-participant_level_long %>% na.omit()

###Remove trials where absolute data.Z>3 (i.e. remove outlier RTs)
# participant_level_long<-participant_level_long[!abs(participant_level_long$data.Z)>3,]

###Shift extream outliers back to +/- 3 standard deviations from the mean
# participant_level_long$data[participant_level_long$data.Z>3]<-m[participant_level_long$Group_by_measure_type][participant_level_long$data.Z>3] + 3*s[participant_level_long$Group_by_measure_type][participant_level_long$data.Z>3]
# participant_level_long$data[participant_level_long$data.Z<(-3)]<-m[participant_level_long$Group_by_measure_type][participant_level_long$data.Z<(-3)] - 3*s[participant_level_long$Group_by_measure_type][participant_level_long$data.Z<(-3)]


#change measure_type to factor class
participant_level_long$Group_by_measure_type<-as.factor(participant_level_long$Group_by_measure_type)

#Put it back into wide format so I can use lapply to do t-test on columns 
drops <- c("data.Z")
participant_level_long<-participant_level_long[ , !(names(participant_level_long) %in% drops)]


#Look for participant level outliers in RT and RT-asymmetry
#calculate RT_Asym.Z inside Group and save it 
m <- tapply(participant_level$RT_Asym,participant_level$Group,mean, na.rm = T)
s <- tapply(participant_level$RT_Asym,participant_level$Group,sd, na.rm = T)
participant_level$RT_Asym.Z <- (participant_level$RT_Asym-m[participant_level$Group])/s[participant_level$Group]

#calculate RT_Left.Z inside Group and save it 
m <- tapply(participant_level$RT_Left,participant_level$Group,mean, na.rm = T)
s <- tapply(participant_level$RT_Left,participant_level$Group,sd, na.rm = T)
participant_level$RT_Left.Z <- (participant_level$RT_Left-m[participant_level$Group])/s[participant_level$Group]

#calculate RT_Right.Z inside Group and save it 
m <- tapply(participant_level$RT_Right,participant_level$Group,mean, na.rm = T)
s <- tapply(participant_level$RT_Right,participant_level$Group,sd, na.rm = T)
participant_level$RT_Right.Z <- (participant_level$RT_Right-m[participant_level$Group])/s[participant_level$Group]


#Kick out RT_Asym outliers
participant_level <- filter(participant_level,
                            abs(RT_Asym.Z)<3)

#Single trial
data <-data[data$ID %in% participant_level$ID, ] 

#This ^ Excludes participants from the ADHD group due to clinical cuttoff CPRS_N_B >= 65
# AD69C', 'AD59C', 'AD27C', 'AD51C', 'AD98C'
#...and excludes  control participants due to clinical cuttoff CPRS_N_B CPRS_N_B <= 60
#'C14', 'C259' for filter_CPRS_N_B; 
#....and also excludes C194 because this participant only had less than 50 valid trials for EEG
#...and also excludes AD11C and AD99C because they are right handed
#.....and excludes AD72C since he broke fixation towards the Left on 95% of left target trials
#.... and C62 was a significant outlier (abs Z>3) for RT_Asym
######################################################


#Save the participant level file as SPSS data folr
# library(haven)
# write_sav(participant_level, file.path(getwd(), "participant_level_data.sav"))

```


#Are there significant Accuracy differences between ADHD and Controls?

```{r, echo=FALSE, warning=FALSE}
###Check for Accuracy outliers
min(participant_level$Accuracy_Total)
min(participant_level$Accuracy_Left)
min(participant_level$Accuracy_Right)

ggplot(participant_level, aes(Accuracy_Total))  + geom_histogram() + facet_wrap(~ Group)
ggplot(participant_level, aes(Accuracy_Left))  + geom_histogram() + facet_wrap(~ Group)
ggplot(participant_level, aes(Accuracy_Right))  + geom_histogram() + facet_wrap(~ Group)

############ Are there significant accuracy differences between ADHD and Controls? 
#Overall Accuracy by Group
log <- capture.output({
Accuracy_Group <- ezPerm(data = participant_level
                                  , dv = .(Accuracy_Total)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Overall Accuracy:")
print(Accuracy_Group);


#Left Target Accuracy by Group
log <- capture.output({
Accuracy_Left_Group <- ezPerm(data = participant_level
                                  , dv = .(Accuracy_Left)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Accuracy for left targets:")
print(Accuracy_Left_Group);


#Right Target Accuracy by Group
log <- capture.output({
Accuracy_Right_Group <- ezPerm(data = participant_level
                                  , dv = .(Accuracy_Right)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Accuracy for right targets:")
print(Accuracy_Right_Group);


#Accuracy Asym by Group
log <- capture.output({
Accuracy_Asym_Group <- ezPerm(data = participant_level
                                  , dv = .(Accuracy_Asym)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Accuracy Asym:")
print(Accuracy_Asym_Group);


##Accuracy by Group and Hemifield
#Reshape participant_level into long format for modeling with ezANOVA:
Perm_data<- participant_level %>%
    select(ID, Accuracy_Left, Accuracy_Right, Group) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)%>%
    mutate(Hemifield=factor(Hemifield)) %>%
    mutate(ID=factor(ID)) 


log <- capture.output({
   Accuracy_GroupbyHemifield <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , between = .(Group)
                          , perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on Accuracy:")
print(Accuracy_GroupbyHemifield);

```


#Are there significant Fixation breaks differences between ADHD and Controls?

```{r, echo=FALSE, warning=FALSE}

## LEFT FixBreak by Group
log <- capture.output({
LeftFixBreak_Group <- ezPerm(data = participant_level
                                  , dv = .(LeftFixBreak_percent)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Leftward Fixation Breaks:")
print(LeftFixBreak_Group);

ggplot(participant_level, aes(LeftFixBreak_percent))  + geom_histogram() + facet_wrap(~ Group)


## Right FixBreak by Group
log <- capture.output({
RightFixBreak_Group <- ezPerm(data = participant_level
                             , dv = .(RightFixBreak_percent)
                             , wid = .(ID)
                             , between = .(Group)
                             , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Rightward Fixation Breaks:")
print(RightFixBreak_Group);


```


#Run tests of normality on the participant_level RT, CPPonset, N2c, etc. measures 
```{r, test of normality, echo=FALSE, warning=FALSE}
options(scipen=99)
Normality_tests <-participant_level %>% 
                    select(contains("Left"), contains("Right"), 
                           -contains("Accuracy"), -contains("FixBreak"),
                           -contains(".Z"))  %>% 
                    gather() %>% 
                    group_by(key) %>%
                    do(ShapiroWilk_p_value= shapiro.test(.$value)[2],
                       Anderson_Darling_p_value = nortest::ad.test(.$value)[2], 
                       CramerVonMises_p_value = nortest::cvm.test(.$value)[2],
                       Shapiro_Francia_p_value = nortest::sf.test(.$value)[2],
                       Kolmogorov_Smirnov_p_value= nortest::lillie.test(.$value)[2]) %>% 
                    mutate(ShapiroWilk_p_value= unlist(ShapiroWilk_p_value),
                       Anderson_Darling_p_value = unlist(Anderson_Darling_p_value), 
                       CramerVonMises_p_value = unlist(CramerVonMises_p_value),
                       Shapiro_Francia_p_value = unlist(Shapiro_Francia_p_value),
                       Kolmogorov_Smirnov_p_value = unlist(Kolmogorov_Smirnov_p_value)) %>% 
                    mutate(average_p_value=(ShapiroWilk_p_value + 
                                                Anderson_Darling_p_value + 
                                                CramerVonMises_p_value + 
                                                Shapiro_Francia_p_value + 
                                                Kolmogorov_Smirnov_p_value)/5) %>% arrange(average_p_value)
kable(Normality_tests,
    format.args = list(big.mark = ","), digits=4,
      caption="Normality tests")
```

#Test the effect of Target Hemifield on RT, CPPonset, N2c, etc. using repeated measures ANOVA

##In cases where the assumption of normality was violated, a factorial permutation test for the effect of Target Hemifield was performed with 1000 permutations and the permuted p-value also reported
```{r, effect of Target Hemifield, echo=FALSE, warning=FALSE}
###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, RT_Left, RT_Right) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)

   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                        , dv = .(dv)
                        , wid = .(ID)
                        , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3)
print("Repeated Measures ANOVA  for the Group*Hemifield effect on RT:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))


ggplot(ANOVA_data, aes(Hemifield, dv, colour = Hemifield))  +
          geom_violin() + 
    geom_boxplot(alpha=0.1) +  
    theme_bw () + 
    geom_point() +
    xlab("Target Hemifield") + ylab("Reaction Time (ms)") + 
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black")) +
     coord_flip() +
    facet_wrap(~Group)

# Density plot
ggplot(participant_level, aes(RT_Asym, fill=Group))  + geom_density(alpha=.4) +
    geom_vline(data=participant_level %>% 
                   group_by(Group) %>% 
                   summarise(RT_Asym.mean=mean(RT_Asym)), 
               aes(xintercept=RT_Asym.mean,  colour=Group),
               linetype="dashed", size=1)

###################################################################

ANOVA_data<- participant_level %>%
    select(ID,Group, CPPonset_LeftTarget, CPPonset_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)



Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on CPP Onset:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))


#Permutation test:
Perm_data<- participant_level %>%
    select(ID,Group, CPPonset_LeftTarget, CPPonset_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)

log <- capture.output({
   Group_by_Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          ,between=Group, perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on CPP Onset:")
print(Group_by_Hemifield_Perm);

ggplot(ANOVA_data, aes(Hemifield, dv, colour = Hemifield))  +
          geom_violin() + 
    geom_boxplot(alpha=0.1) +  
    theme_bw () + 
    geom_point() +
    xlab("Target Hemifield") + ylab("CPP Onset (ms)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black"))+
     coord_flip() +
    facet_wrap(~Group)



###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, CPPslope_LeftTarget, CPPslope_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)



   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on CPP Slope:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, N2i_latency_LeftTarget, N2i_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)


   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on N2i_latency:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

#Permutation test:
Perm_data<- participant_level %>%
    select(ID,Group, N2i_latency_LeftTarget, N2i_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)

log <- capture.output({
   Group_by_Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          ,between=Group, perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on N2i_latency:")
print(Group_by_Hemifield_Perm);

###################################################################
ANOVA_data<- participant_level %>%
    select(ID, Group, N2i_LeftTarget_GA, N2i_RightTarget_GA) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)


   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on N2i Amplitude:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, N2c_latency_LeftTarget, N2c_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)


   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on N2c_latency:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

#Permutation test:
Perm_data<- participant_level %>%
    select(ID,Group, N2c_latency_LeftTarget, N2c_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)

log <- capture.output({
   Group_by_Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          ,between=Group, perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on N2c_latency:")
print(Group_by_Hemifield_Perm);

###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, N2c_LeftTarget_GA, N2c_RightTarget_GA) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)


   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on N2c Amplitude:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

###################################################################
#combine N2c and N2i into the one analysis and test for the TargetHemifield*Hemisphere interaction:
ANOVA_data<- participant_level %>%
    select(ID, Group, N2c_LeftTarget_PA, N2c_RightTarget_PA, N2i_LeftTarget_PA, N2i_RightTarget_PA) %>%
    na.omit() %>%
    gather(condition, dv, -ID, -Group) %>%
    mutate(Hemifield = replace(condition, condition=="N2c_LeftTarget_PA" | condition=="N2i_LeftTarget_PA", "Left")) %>%
    mutate(Hemifield = replace(Hemifield, condition=="N2c_RightTarget_PA" | condition=="N2i_RightTarget_PA", "Right")) %>%
    mutate(Hemisphere = replace(condition, condition=="N2i_LeftTarget_PA" | condition=="N2i_RightTarget_PA", "Ipsilateral")) %>%
    mutate(Hemisphere = replace(Hemisphere, condition=="N2c_LeftTarget_PA" | condition=="N2c_RightTarget_PA", "Contralateral")) %>%
    as.data.frame()


Hemifield_Hemisphere_ANOVA <- ezANOVA(data = ANOVA_data
                              , dv = .(dv)
                              , wid = .(ID)
                              , within = .(Hemifield, Hemisphere)
                                , within_covariates = NULL
                                , between = Group
                                , between_covariates = NULL
                                , observed = NULL
                                , type = 3);
print("Repeated Measures ANOVA for the effects of Hemifield*Hemisphere on N2_PA Amplitude:")
print(Hemifield_Hemisphere_ANOVA);


ANOVA_data<- participant_level %>%
    select(ID, Group, N2c_LeftTarget_GA, N2c_RightTarget_GA, N2i_LeftTarget_GA, N2i_RightTarget_GA) %>%
    na.omit() %>%
    gather(condition, dv, -ID, -Group) %>%
    mutate(Hemifield = replace(condition, condition=="N2c_LeftTarget_GA" | condition=="N2i_LeftTarget_GA", "Left")) %>%
    mutate(Hemifield = replace(Hemifield, condition=="N2c_RightTarget_GA" | condition=="N2i_RightTarget_GA", "Right")) %>%
    mutate(Hemisphere = replace(condition, condition=="N2i_LeftTarget_GA" | condition=="N2i_RightTarget_GA", "Ipsilateral")) %>%
    mutate(Hemisphere = replace(Hemisphere, condition=="N2c_LeftTarget_GA" | condition=="N2c_RightTarget_GA", "Contralateral")) %>%
    as.data.frame()


Hemifield_Hemisphere_ANOVA <- ezANOVA(data = ANOVA_data
                              , dv = .(dv)
                              , wid = .(ID)
                              , within = .(Hemifield, Hemisphere)
                                , within_covariates = NULL
                                , between = Group
                                , between_covariates = NULL
                                , observed = NULL
                                , type = 3);
print("Repeated Measures ANOVA for the effects of Hemifield*Hemisphere on N2_GA Amplitude:")
print(Hemifield_Hemisphere_ANOVA);

###################################################################


ANOVA_data<- participant_level %>%
    select(ID,Group, PreAlpha_LeftHemi, PreAlpha_RightHemi) %>%
    na.omit() %>%
    gather(Hemisphere, dv, -ID, -Group)


   Hemisphere_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemisphere)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemisphere on Pre-target Alpha Power:")
print(Hemisphere_ANOVA);


kable(ANOVA_data %>% group_by(Group, Hemisphere) %>% summarise(mean=mean(dv),sd=sd(dv)))

Perm_data<- participant_level %>%
    select(ID,Group, PreAlpha_LeftHemi, PreAlpha_RightHemi) %>%
    na.omit() %>%
    gather(Hemisphere, dv, -ID, -Group)

log <- capture.output({
   Hemisphere_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemisphere)
                          , between=Group, 
                          perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemisphere on Pre-target Alpha Power:")
print(Hemisphere_Perm);


ggplot(ANOVA_data, aes(Hemisphere, dv, colour = Hemisphere))  +
    geom_violin() + 
    geom_boxplot(alpha=0.1) +  
    geom_point() +
    xlab("Hemisphere") + ylab("Alpha Power (uV)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12), 
          axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(face="bold", angle=0, size=12),
          panel.background = element_blank()) +
    guides(colour=FALSE) +
    scale_x_discrete(labels=c("Left", "Right")) +
    facet_wrap(~Group)


######################################################################
```

#Test the Group x Hemifield effect on single trial RTs:

```{r, echo=FALSE, warning=FALSE}
########################### Multi-level Models ########################## 
data2<-data[!data$LeftFixBreakneg100_100PR  &!data$RightFixBreakneg100_100PR,]

# RT_random_intercepts_only<-glmer(RT ~ 1 + (1 | Group/ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2, family = Gamma(link = log), na.action = na.omit)
RT_random_intercepts_only<-lmer(log(RT) ~ 1 + (1 | ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2, REML=FALSE, na.action = na.omit)
RT_Group<-update(RT_random_intercepts_only, .~. + Group)
RT_Hemifield<-update(RT_Group, .~. + Hemifield)
RT_HemifieldbyGroup<-update(RT_Hemifield, .~. + Hemifield:Group)
anova(RT_random_intercepts_only, RT_Group, RT_Hemifield, RT_HemifieldbyGroup)

RT_random_intercepts_only<-lmer(log(RT) ~ 1 + (Hemifield | ID) +(1|ITI) + (1|Trial), data = data2, REML=FALSE, na.action = na.omit)
RT_Group<-update(RT_random_intercepts_only, .~. + Group)
RT_Hemifield<-update(RT_Group, .~. + Hemifield)
RT_HemifieldbyGroup<-update(RT_Hemifield, .~. + Hemifield:Group)
anova(RT_random_intercepts_only, RT_Group, RT_Hemifield, RT_HemifieldbyGroup)



##Try Group * Hemifield interaction on RT (rather than using RT-asym)
#So get participant level RT into long format so I can run permutated mixed model anova 
Perm_data<- participant_level %>%
    select(ID,Group, RT_Left, RT_Right, Group) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)%>%
    mutate(Hemifield=factor(Hemifield)) %>%
    mutate(ID=factor(ID)) 

log <- capture.output({
   Group_by_Hemifield_Perm <- ezPerm(data = as.data.frame(Perm_data)
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , between = .(Group)
                          ,perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on RT:")
print(Group_by_Hemifield_Perm);



```



**So controls have significantly faster RTs overall, and there is a significant Group x Hemifield effect**

##Break down the significant Group x Hemifield effect on RT
```{r, echo=FALSE, warning=FALSE}
#########Break down the signifiant Hemifield by group interaction:
#look at the effect of Hemifield for ADHD only  -
summary(glht(lmer(log(RT) ~ Hemifield + (1|ID)+(1|ITI) + (1|Hemifield)+ (1|Trial), data = data2[data2$Group=="ADHD",], REML=FALSE, na.action = na.omit)))
#look at the effect of Hemifield for Control only - 
summary(glht(lmer(log(RT) ~ Hemifield + (1|ID)+(1|ITI) + (1|Hemifield)+ (1|Trial), data = data2[data2$Group=="Control",], REML=FALSE, na.action = na.omit)))

```

###So Controls have significant pseudoneglect (i.e. faster RTs to left hemifield targets), and ADHD do not

**Lets plot this:**

```{r, echo=FALSE, warning=FALSE}


detach("package:dplyr", unload=TRUE) #Detach dplyr as functions below use plyr
source("summarySE.R") 
source("summarySEwithin.R") #function to calculate Std.Er of mean
source("normDataWithin.R")
plotdata <- summarySEwithin(data2, measurevar="RT", withinvars=c("Hemifield"), betweenvars="Group", idvar="ID")
lapply(required_packages, require, character.only = TRUE) # re-load all librarys no that I'm finished with dlyr
ggplot(plotdata, aes(x=Group, y=RT, fill=Hemifield)) +
    geom_bar(position=position_dodge(.9), colour="Black", stat="identity") + 
    geom_errorbar(position=position_dodge(.9), width=.3, aes(ymin=RT-ci, ymax=RT+ci)) + #can change "se" to "ci" if I want to use 95%ci instead
    geom_hline(yintercept=0) +  coord_cartesian(ylim = c(700, 900)) +
    xlab("Hemifield") + ylab("RT (ms)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black")) 


#look at it over time-on-task
ggplot(data2, aes(Trial, RT, fill=Hemifield,colour=Hemifield)) +
    stat_smooth(method="glm",level = 0.95,size=1) + 
    theme(axis.title.x = element_text(face="bold", size=14),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=14),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=14, face="bold")) +
    theme(legend.text = element_text(size = 12, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black"))  + 
    facet_wrap(~ Group)


```

###Next I'll move on to look at the EEG data. This EEG data was low-pass filtered to 35Hz, and no high-pass filter applied. No CSD transformation was applied:

#Single trial N2 Amplitude 

###N2c/i measurement window (100ms) was centred on peak amplitude of each INDIVIDUAL PARTICIANT's AVERAGE N2c/i waveforms:

```{r, echo=FALSE, message=FALSE}
# 
ANOVA_data<- participant_level %>%
    select(ID, Group, N2c_LeftTarget_PA, N2c_RightTarget_PA, N2i_LeftTarget_PA, N2i_RightTarget_PA) %>%
    na.omit() %>%
    gather(condition, dv, -ID, -Group) %>%
    mutate(Hemifield = replace(condition, condition=="N2c_LeftTarget_PA" | condition=="N2i_LeftTarget_PA", "Left")) %>%
    mutate(Hemifield = replace(Hemifield, condition=="N2c_RightTarget_PA" | condition=="N2i_RightTarget_PA", "Right")) %>%
    mutate(Hemisphere = replace(condition, condition=="N2i_LeftTarget_PA" | condition=="N2i_RightTarget_PA", "Ipsilateral")) %>%
    mutate(Hemisphere = replace(Hemisphere, condition=="N2c_LeftTarget_PA" | condition=="N2c_RightTarget_PA", "Contralateral")) %>%
    as.data.frame()

log <- capture.output({
N2amp_perm <- ezPerm(data = ANOVA_data
                                  , dv = .(dv)
                                  , wid = .(ID)
                                  , within = .(Hemifield, Hemisphere)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the Hemifield*Hemisphere*Group on the N2_PA:")
print(N2amp_perm);


ANOVA_data<- participant_level %>%
    select(ID, Group, N2c_LeftTarget_GA, N2c_RightTarget_GA, N2i_LeftTarget_GA, N2i_RightTarget_GA) %>%
    na.omit() %>%
    gather(condition, dv, -ID, -Group) %>%
    mutate(Hemifield = replace(condition, condition=="N2c_LeftTarget_GA" | condition=="N2i_LeftTarget_GA", "Left")) %>%
    mutate(Hemifield = replace(Hemifield, condition=="N2c_RightTarget_GA" | condition=="N2i_RightTarget_GA", "Right")) %>%
    mutate(Hemisphere = replace(condition, condition=="N2i_LeftTarget_GA" | condition=="N2i_RightTarget_GA", "Ipsilateral")) %>%
    mutate(Hemisphere = replace(Hemisphere, condition=="N2c_LeftTarget_GA" | condition=="N2c_RightTarget_GA", "Contralateral")) %>%
    as.data.frame()

log <- capture.output({
N2amp_perm <- ezPerm(data = ANOVA_data
                                  , dv = .(dv)
                                  , wid = .(ID)
                                  , within = .(Hemifield, Hemisphere)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the Hemifield*Hemisphere*Group on the N2_GA:")
print(N2amp_perm);



#Make Hemisphere a factor:
DF<-select(data, ID, ITI, Hemifield, N2c_PA, N2i_PA, Trial, Blinkneg100_450, LeftFixBreakneg100_450, RightFixBreakneg100_450, Art_neg100_450, 
                  BothFixBreakneg100_450, Group, Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh)

DF$contralateral<-rep("contralateral",length(DF[,1]))
DF$ipsilateral<-rep("ipsilateral",length(DF[,1]))               
DF_contralateral<-subset(DF, select=c(ID, ITI, Hemifield,N2c_PA,contralateral,Trial,Blinkneg100_450, 
                                      LeftFixBreakneg100_450, RightFixBreakneg100_450, Art_neg100_450, BothFixBreakneg100_450,Group,
                                      Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh))
DF_ipsilateral<-subset(DF, select=c(ID, ITI, Hemifield,N2i_PA,ipsilateral,Trial,Blinkneg100_450, 
                                    LeftFixBreakneg100_450, RightFixBreakneg100_450, Art_neg100_450, BothFixBreakneg100_450,Group,
                                    Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh))

names(DF_contralateral)[names(DF_contralateral)=="contralateral"] <- "Hemisphere"
names(DF_ipsilateral)[names(DF_ipsilateral)=="ipsilateral"] <- "Hemisphere"
names(DF_contralateral)[names(DF_contralateral)=="N2c_PA"] <- "N2"
names(DF_ipsilateral)[names(DF_ipsilateral)=="N2i_PA"] <- "N2"
DF<-rbind(DF_contralateral,DF_ipsilateral)
rm(DF_contralateral,DF_ipsilateral)
DF$Hemisphere <- factor(DF$Hemisphere)

DF<-DF[!DF$Blinkneg100_450 & !DF$LeftFixBreakneg100_450 & !DF$RightFixBreakneg100_450 & !DF$Art_neg100_450 & !DF$BothFixBreakneg100_450, ]


DF$IDbyHemifieldbyITIbyHemispherebyHemisphere<-interaction(DF$ID, DF$Hemifield, DF$ITI, DF$Hemisphere)
#calculate mean and sd 
m <- tapply(DF$N2,DF$IDbyHemifieldbyITIbyHemisphere,mean)
s <- sqrt(tapply(DF$N2,DF$IDbyHemifieldbyITIbyHemisphere,var))
#calculate N2.Z and save it inside data.frame
DF$N2.Z <- (DF$N2-m[DF$IDbyHemifieldbyITIbyHemisphere])/s[DF$IDbyHemifieldbyITIbyHemisphere]
#check that Z scores have mean=0 and std=1 
N2.Z_checker <- ddply(DF, c("ID", "Hemifield", "ITI", "Hemisphere"), summarise,
                      N    = length(N2.Z ),
                      mean = round(mean(N2.Z )),
                      sd   = sd(N2.Z ),
                      se   = sd / sqrt(N))

##Remove trials where absolute N2.Z>3 (i.e. remove outlier N2s)
DF<-DF[!abs(DF$N2.Z)>3,]

# hist_N2<-ggplot(DF, aes(N2))  + geom_histogram(aes(y=..count..), colour="black", fill="white") 
# hist_N2 + facet_wrap(~ ID)
# hist(DF$N2)

###Run the mixed model  
N2_random_intercepts_only<-lmer(N2 ~ 1 + (1 | ID/Hemisphere) +(1|ITI) + (1|Hemifield) + (1|Trial), data = DF, REML=FALSE, na.action = na.omit)
N2_Group<-update(N2_random_intercepts_only, .~. + Group)
N2_Hemifield<-update(N2_Group, .~. + Hemifield)
N2_Hemisphere<-update(N2_Hemifield, .~. + Hemisphere)
N2_HemifieldbyGroup<-update(N2_Hemisphere, .~. + Hemifield:Group)
N2_HemispherebyGroup<-update(N2_HemifieldbyGroup, .~. + Hemisphere:Group)
N2_HemifieldbyHemisphere<-update(N2_HemispherebyGroup, .~. + Hemisphere:Hemifield)
N2_HemifieldbyGroupbyHemisphere<-update(N2_HemifieldbyHemisphere, .~. + Hemifield:Group:Hemisphere)
anova(N2_random_intercepts_only, N2_Group, N2_Hemifield, N2_Hemisphere, N2_HemifieldbyGroup, N2_HemispherebyGroup, N2_HemifieldbyHemisphere, N2_HemifieldbyGroupbyHemisphere)



N2_random_effects_only<-lmer(N2 ~ 1 + (Hemifield | ID/Hemisphere) +(1|ITI) + (1|Trial), data = DF, REML=FALSE, na.action = na.omit)
N2_Group<-update(N2_random_effects_only, .~. + Group)
N2_Hemifield<-update(N2_Group, .~. + Hemifield)
N2_Hemisphere<-update(N2_Hemifield, .~. + Hemisphere)
N2_HemifieldbyGroup<-update(N2_Hemisphere, .~. + Hemifield:Group)
N2_HemispherebyGroup<-update(N2_HemifieldbyGroup, .~. + Hemisphere:Group)
N2_HemifieldbyHemisphere<-update(N2_HemispherebyGroup, .~. + Hemisphere:Hemifield)
N2_HemifieldbyGroupbyHemisphere<-update(N2_HemifieldbyHemisphere, .~. + Hemifield:Group:Hemisphere)
anova(N2_random_effects_only, N2_Group, N2_Hemifield, N2_Hemisphere, N2_HemifieldbyGroup, N2_HemispherebyGroup, N2_HemifieldbyHemisphere, N2_HemifieldbyGroupbyHemisphere)


#############################################################################################################
############################################################################################################
```

###So there is a significant Group x Hemifield x Hemisphere

**Plot it:**

**First Plot the marginal N2 means and 95% CIs predicted by the model:**

```{r, echo=FALSE, message=FALSE}
require(effects)
plot(allEffects(N2_HemifieldbyGroupbyHemisphere), multiline=T,x.var="Hemifield", z.var="Hemisphere", alternating=F, ci.style="bars")
```

**Now plot the actual N2 data (note these error bars are std. error):**

```{r, echo=FALSE, message=FALSE}

detach("package:dplyr", unload=TRUE) #Detach dplyr as functions below use plyr
source("summarySE.R") 
source("summarySEwithin.R") #function to calculate Std.Er of mean
source("normDataWithin.R")
plotdata <- summarySEwithin(DF, measurevar="N2", withinvars=c("Hemisphere","Hemifield"), betweenvars="Group", idvar="ID")
lapply(required_packages, require, character.only = TRUE) # re-load all librarys no that I'm finished with dlyr
# plotdata$N2<-abs(plotdata$N2)
N2_BarPlot_Group<-ggplot(plotdata, aes(x=Hemisphere, y=N2, fill=Hemifield)) +
    geom_bar(position=position_dodge(.9), colour="Black", stat="identity") + 
    geom_errorbar(position=position_dodge(.9), width=.3, aes(ymin=N2-se, ymax=N2+se)) + #can change "se" to "ci" if I want to use 95%ci instead
    geom_hline(yintercept=0) +  coord_cartesian(ylim = c(1, -2.7)) +
    xlab("Hemisphere") + ylab("N2 Amplitude (uV)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~ Group)

load(file = "StimLockedN2_Plot_Group.gg")

StimLockedN2_Plot_Group

N2_BarPlot_Group


```

###Break down the significant Group x Hemifield x Hemisphere effect. Test simple effect of 'Group' inside each combination of hemifield x Hemisphere 


```{r, echo=FALSE, message=FALSE}

# ##############** First test for Group x Hemisphere interaction for left hemifield targets only and for right targets only**##############
# #Test for Group*Hemisphere interaction for Left-targets only   -
# baseline_LTonly<-lmer(N2 ~ Group + Hemisphere  +  (1 | ID/Hemisphere) +(1|ITI)  + (1|Trial), data = DF[DF$Hemifield=="Left",], REML=FALSE, na.action = na.omit)
# GroupbyHemisphere_LTonly<-update(baseline_LTonly , .~. + Group*Hemisphere)
# anova(baseline_LTonly,GroupbyHemisphere_LTonly)
# 
# #Test for  Group*Hemisphere for Right-targets only   -
# baseline_RTonly<-lmer(N2 ~ Group + Hemisphere  +  (1 | ID/Hemisphere) +(1|ITI)  + (1|Trial), data = DF[DF$Hemifield=="Right",], REML=FALSE, na.action = na.omit)
# GroupbyHemisphere_RTonly<-update(baseline_RTonly , .~. + Group*Hemisphere)
# anova(baseline_RTonly,GroupbyHemisphere_RTonly)

# **So only left hemifield targets have a significant Group*Hemisphere effect.**


#look at the effect of Group for Left target N2c  -
summary(glht(lmer(N2 ~ Group + (1 | ID) +(1|ITI)  + (1|Trial), data = DF[DF$Hemifield=="Left" & DF$Hemisphere=="contralateral",], REML=FALSE, na.action = na.omit)))
#look at the effect of Group for Left target N2i -
summary(glht(lmer(N2 ~ Group + (1 | ID) +(1|ITI)  + (1|Trial), data = DF[DF$Hemifield=="Left" & DF$Hemisphere=="ipsilateral",], REML=FALSE, na.action = na.omit)))

#look at the effect of Group for Right target N2c -
summary(glht(lmer(N2 ~ Group + (1 | ID) +(1|ITI)  + (1|Trial), data = DF[DF$Hemifield=="Right" & DF$Hemisphere=="contralateral",], REML=FALSE, na.action = na.omit)))
#look at the effect of Group for Right target N2i  -
summary(glht(lmer(N2 ~ Group + (1 | ID) +(1|ITI)  + (1|Trial), data = DF[DF$Hemifield=="Right" & DF$Hemisphere=="ipsilateral",], REML=FALSE, na.action = na.omit)))



## NO EFFECTS OF TOT on N2:
##Check for TOT effects:
# N2_TOT<-update(N2_HemifieldbyGroupbyHemisphere, .~. + Trial)
# N2_GroupbyTOT<-update(N2_TOT, .~. + Trial*Group)
# N2_HemifieldbyTOT<-update(N2_GroupbyTOT, .~. + Trial*Hemifield)
# N2_HemispherebyTOT<-update(N2_HemifieldbyTOT, .~. + Trial*Hemisphere)
# N2_HemifieldbyGroupbyTOT<-update(N2_HemispherebyTOT, .~. + Trial*Hemifield*Group)
# N2_HemispherebyGroupbyTOT<-update(N2_HemifieldbyGroupbyTOT, .~. + Trial*Hemisphere*Group)
# N2_HemifieldbyHemispherebyTOT<-update(N2_HemispherebyGroupbyTOT, .~. + Trial*Hemisphere*Hemifield)
# N2_HemifieldbyGroupbyHemispherebyTOT<-update(N2_HemifieldbyHemispherebyTOT, .~. + Trial*Hemisphere*Hemifield*Group)
# anova(N2_HemifieldbyGroupbyHemisphere, N2_TOT, N2_GroupbyTOT, N2_HemifieldbyTOT,N2_HemispherebyTOT,N2_HemifieldbyGroupbyTOT,N2_HemispherebyGroupbyTOT,N2_HemifieldbyHemispherebyTOT,N2_HemifieldbyGroupbyHemispherebyTOT)

```

###So the interaction is driven by a significantly larger left target N2c in Controls than in ADHD



```{r, echo=FALSE, message=FALSE, include=FALSE}
##Check assumptions for  model by plotting residuals:
residuals_N2_HemifieldbyGroupbyHemisphere=residuals(N2_HemifieldbyGroupbyHemisphere)
plot(residuals_N2_HemifieldbyGroupbyHemisphere)
qqnorm(residuals_N2_HemifieldbyGroupbyHemisphere)
qqline(residuals_N2_HemifieldbyGroupbyHemisphere)
hist(residuals_N2_HemifieldbyGroupbyHemisphere)


```


#CPP onset 

###CPP onset was measured on a participant level (rather than on a single trial level) using the same method as Ger's Current Biology paper

```{r, echo=FALSE, message=FALSE}
#Reshape participant_level into long format for modeling with lmw4:
CPPonset_participant_level_long<- participant_level %>%
    select(ID, Group, CPPonset_LeftTarget, CPPonset_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, CPPonset, -ID, -Group)

# # #Check which participant have invalid CPPonset
CPPonset_participant_level_long[CPPonset_participant_level_long$CPPonset==0,]
#Remove any participants with CPP onsets of zero as they are not valid
CPPonset_participant_level_long<-CPPonset_participant_level_long[CPPonset_participant_level_long$CPPonset!=0,]

ezANOVA(
    data = CPPonset_participant_level_long
    , dv = .(CPPonset)
    , wid = .(ID)
    , within = .(Hemifield)
    , within_full = .(Hemifield)
    , between = (Group)
    , type = 3
    , detailed = F
)


##Test the Hemifield_By_Group effect in CPP onset
CPPonset_random_intercepts_only<-lmer(CPPonset ~ 1 + (1 | Group/ID) +(1|Hemifield), data = CPPonset_participant_level_long, REML=FALSE, na.action = na.omit)
CPPonset_Hemifield<-update(CPPonset_random_intercepts_only, .~. + Hemifield)
CPPonset_Group<-update(CPPonset_Hemifield, .~. + Group)
CPPonset_Hemifield_By_Group<-update(CPPonset_Group, .~. + Hemifield*Group)
anova(CPPonset_random_intercepts_only, CPPonset_Hemifield, CPPonset_Group, CPPonset_Hemifield_By_Group)

```

###So there is a significant Group x Hemifield effect for CPP onset

**Now plot the actual CPPonset data:**

```{r, echo=FALSE, message=FALSE}

load(file = "StimLockedCPP_Plot.gg")
StimLockedCPP_Plot

detach("package:dplyr", unload=TRUE) #Detach dplyr as functions below use plyr
source("summarySE.R") 
source("summarySEwithin.R") #function to calculate Std.Er of mean
source("normDataWithin.R")
plotdata <- summarySEwithin(DF, measurevar="N2", withinvars=c("Hemisphere","Hemifield"), betweenvars="Group", idvar="ID")
plotdata <- summarySEwithin(CPPonset_participant_level_long, measurevar="CPPonset", withinvars=c("Hemifield"), betweenvars="Group", idvar="ID")
ggplot(plotdata, aes(x=Group, y=CPPonset, fill=Hemifield)) +
    geom_bar(position=position_dodge(.9), colour="Black", stat="identity") + 
    geom_errorbar(position=position_dodge(.9), width=.3, aes(ymin=CPPonset-se, ymax=CPPonset+se)) + #can change "se" to "ci" if I want to use 95%ci instead
    geom_hline(yintercept=0) +  coord_cartesian(ylim = c(0, 500)) +
    xlab("Group") + ylab("CPP Onset Latency (ms)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black"))  





# #Try a boxplot		
# CPPBoxplot <- ggplot(CPPonset_participant_level_long, aes(Group, CPPonset, colour = Hemifield))  +
#     geom_boxplot() +  xlim = c(-100, 1500) + coord_flip() + theme_bw ()

```


###Break down the significant Group x Hemifield CPPonset effect. Test simple effect of 'hemifield' inside each Group

```{r, echo=FALSE, message=FALSE}


#look at the effect of Hemifield for ADHD participant's CPPonset  -
summary(glht(lmer(CPPonset ~ Hemifield + (1 | ID) +(1|Hemifield), data = CPPonset_participant_level_long[CPPonset_participant_level_long$Group=="ADHD",], REML=FALSE, na.action = na.omit)))

#look at the effect of Hemifield for Control participant's CPPonset  -
summary(glht(lmer(CPPonset ~ Hemifield + (1 | ID) +(1|Hemifield), data = CPPonset_participant_level_long[CPPonset_participant_level_long$Group=="Control",], REML=FALSE, na.action = na.omit)))

```
**So Control participants have significantly ealier CPP onset for Left Hemifield Targets than for Right, while there is no significant target hemifield effect for ADHD**

**Could also just use classic (between and within groups) t-tests for this since the data is full aggregated/collapsed to participant level.....**
```{r, echo=FALSE, message=FALSE}

###Can also use t-tests:
#test the effect of Hemifield inside ADHD 
data2<-CPPonset_participant_level_long[CPPonset_participant_level_long$Group=="ADHD",]
t.test(data2$CPPonset[data2$Hemifield=="Left"], data2$CPPonset[data2$Hemifield=="Right"], paired=T)  
#test the effect of Hemifield inside Controls 
data2<-CPPonset_participant_level_long[CPPonset_participant_level_long$Group=="Control",]
t.test(data2$CPPonset[data2$Hemifield=="Left"], data2$CPPonset[data2$Hemifield=="Right"], paired=T)  

#Test the effect of Group for Left Hemifield targets
data2<-CPPonset_participant_level_long[CPPonset_participant_level_long$Hemifield=="Left",]
t.test(data2$CPPonset~ data2$Group) 
#Test the effect of Group for Right Hemifield targets
data2<-CPPonset_participant_level_long[CPPonset_participant_level_long$Hemifield=="Right",]
t.test(data2$CPPonset~ data2$Group) 




```

###So Control participants have significantly ealier CPP onset for Left Hemifield Targets than for Right, while there is no significant target hemifield effect for ADHD. Also Controls' Left Hemifield CPP onset is significantly earlier than those with ADHD

**this ^ CPP onset effect mirrors the Group x Hemifield effect in the RT data)**



#Resp-locked CPP slope analysis (measured on participant level waveforms, not single-trial)

```{r, echo=FALSE, message=FALSE}
CPPslope_participant_level_long<- participant_level %>%
    select(ID, Group, CPPslope_LeftTarget, CPPslope_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, CPPslope, -ID, -Group)


#Find CPPslope Outliers 
CPPslope_participant_level_long$CPPslope.Z<-scale(CPPslope_participant_level_long$CPPslope)
#Check which participants have outlier CPPslopes
CPPslope_participant_level_long[!abs(CPPslope_participant_level_long$CPPslope.Z)<3,]
#Remove CPPslope Outliers 
CPPslope_participant_level_long<-CPPslope_participant_level_long[abs(CPPslope_participant_level_long$CPPslope.Z)<3,]

# #Histogram of participant's CPPslope scores by group and Hemifield 
# CPPslope_participant_level_long$Hemifield_By_Group<-interaction(CPPslope_participant_level_long$Hemifield, CPPslope_participant_level_long$Group)
# ggplot(CPPslope_participant_level_long, aes(CPPslope))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Hemifield_By_Group)



CPPslope_random_intercepts_only<-lmer(CPPslope ~ 1 + (1 | Group/ID) +(1|Hemifield), data = CPPslope_participant_level_long, REML=FALSE, na.action = na.omit)
CPPslope_Hemifield<-update(CPPslope_random_intercepts_only, .~. + Hemifield)
CPPslope_Group<-update(CPPslope_Hemifield, .~. + Group)
CPPslope_Hemifield_By_Group<-update(CPPslope_Group, .~. + Hemifield*Group)
anova(CPPslope_random_intercepts_only, CPPslope_Hemifield, CPPslope_Group, CPPslope_Hemifield_By_Group)



load(file = "RespLockedCPP_Plot.gg")
RespLockedCPP_Plot



```

```{r, echo=FALSE, message=FALSE, include=FALSE}
##Check assumptions for  model by plotting residuals:
residuals_CPPslope_Hemifield_By_Group=residuals(CPPslope_Hemifield_By_Group)
plot(residuals_CPPslope_Hemifield_By_Group)
qqnorm(residuals_CPPslope_Hemifield_By_Group)
qqline(residuals_CPPslope_Hemifield_By_Group)
hist(residuals_CPPslope_Hemifield_By_Group)


```


###So there is no differences in response-locked CPP slope between ADHD and Controls 




#Participant level N2_latency analysis
```{r, echo=FALSE, message=FALSE}
#Reshape participant_level into long format for modeling with lmw4:
N2_latency_participant_level_long <- melt(participant_level, id.vars=c("ID", "Gender", "Group", "Age", "DAT1_3UTR"), 
                                          measure.vars=c("N2c_latency_LeftTarget", "N2c_latency_RightTarget", "N2i_latency_LeftTarget", "N2i_latency_RightTarget" ), 
                                          variable.name="Hemifield_by_Hemisphere",
                                          value.name="N2_latency")

#Create seperate target Hemifield and Hemisphere factors
N2_latency_participant_level_long$Hemifield<-revalue(N2_latency_participant_level_long$Hemifield_by_Hemisphere, c("N2c_latency_LeftTarget"="Left","N2i_latency_LeftTarget"="Left", "N2c_latency_RightTarget"="Right", "N2i_latency_RightTarget"="Right"))

N2_latency_participant_level_long$Hemisphere<-revalue(N2_latency_participant_level_long$Hemifield_by_Hemisphere, c("N2c_latency_LeftTarget"="Contralateral","N2i_latency_LeftTarget"="Ipsilateral", "N2c_latency_RightTarget"="Contralateral", "N2i_latency_RightTarget"="Ipsilateral"))

#Histogram of participant's N2c_latency scores by group and Hemifield 
N2_latency_participant_level_long$Group_by_Hemifield_By_Hemisphere<-interaction(N2_latency_participant_level_long$Group,N2_latency_participant_level_long$Hemifield, N2_latency_participant_level_long$Hemisphere)
ggplot(N2_latency_participant_level_long, aes(N2_latency))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group_by_Hemifield_By_Hemisphere, ncol = 2)

#Negative skew
hist(N2_latency_participant_level_long$N2_latency)
#To reflect a variable, find the largest score in the distribution...
largest<-max(N2_latency_participant_level_long$N2_latency)
#...then add 1 to it for form a constant that is larget than any score in the distribution...
constant<-largest+1
#then create a new variable by subtracting each score from the constant....
N2_latency_participant_level_long$N2_latency_reflected<-constant-N2_latency_participant_level_long$N2_latency
#now plot the reflected distribution:
hist(N2_latency_participant_level_long$N2_latency_reflected)
#now see of a sqrt transformation helps
hist(sqrt(N2_latency_participant_level_long$N2_latency_reflected))

#Can't fix the skew or take it into account with the modle. Therefore will have to do a factorial permutation test 

########################################################
# #Find N2_latency Outliers 
# N2_latency_participant_level_long$N2_latency.Z<-scale(N2_latency_participant_level_long$N2_latency)
# hist(N2_latency_participant_level_long$N2_latency.Z)
# #Check which participants have outlier N2_latencys
# N2_latency_participant_level_long[!abs(N2_latency_participant_level_long$N2_latency.Z)<3,]
# 
# 
# #model N2_latency as a function of Group, Hemifield, and Hemisphere
# N2latency_random_intercepts_only<-lmer(N2_latency ~ 1 + (1 | Group/ID/Hemisphere) +(1|Hemifield), data = N2_latency_participant_level_long, REML=FALSE, na.action = na.omit)
# # N2latency_random_intercepts_only<-glmer(N2_latency_reflected ~ 1 + (1 | Group/ID/Hemisphere) +(1|Hemifield), data = N2_latency_participant_level_long, family = Gamma(link = log), na.action = na.omit)
# N2latency_Group<-update(N2latency_random_intercepts_only, .~. + Group)
# N2latency_Hemifield<-update(N2latency_Group, .~. + Hemifield)
# N2latency_Hemisphere<-update(N2latency_Hemifield, .~. + Hemisphere)
# N2latency_Group_by_Hemifield<-update(N2latency_Hemisphere, .~. + Group*Hemifield)
# N2latency_Group_by_Hemisphere<-update(N2latency_Group_by_Hemifield, .~. + Group*Hemisphere)
# N2latency_Hemifield_by_Hemisphere<-update(N2latency_Group_by_Hemisphere, .~. + Hemifield*Hemisphere)
# N2latency_Group_by_Hemifield_By_Hemisphere<-update(N2latency_Hemifield_by_Hemisphere, .~. + Group*Hemifield*Hemisphere)
# 
# anova(N2latency_random_intercepts_only, N2latency_Group, N2latency_Hemifield, N2latency_Hemisphere, N2latency_Group_by_Hemifield, N2latency_Group_by_Hemisphere, N2latency_Hemifield_by_Hemisphere,N2latency_Group_by_Hemifield_By_Hemisphere)
# 
# require(effects)
# plot(allEffects(N2latency_Hemisphere))
# 
# ##Check assumptions for  model by plotting residuals:
# residuals_N2latency_Group_by_Hemifield_By_Hemisphere=residuals(N2latency_Group_by_Hemifield_By_Hemisphere)
# plot(residuals_N2latency_Group_by_Hemifield_By_Hemisphere)
# qqnorm(residuals_N2latency_Group_by_Hemifield_By_Hemisphere)
# qqline(residuals_N2latency_Group_by_Hemifield_By_Hemisphere)
# hist(residuals_N2latency_Group_by_Hemifield_By_Hemisphere)
# 
# 
# residuals_N2latency_Hemisphere=residuals(N2latency_Hemisphere)
# plot(residuals_N2latency_Hemisphere)
# qqnorm(residuals_N2latency_Hemisphere)
# qqline(residuals_N2latency_Hemisphere)
# hist(residuals_N2latency_Hemisphere)

```

###Can't account for the skew in N2_latency data. Therefore do a factorial permutation test:

```{r, echo=FALSE, message=FALSE, include=FALSE}

boot<-ezBoot(data = N2_latency_participant_level_long, dv = .(N2_latency), wid = .(ID),  between = .(Group), within = .(Hemifield, Hemisphere), resample_within=F)
ezPlot2(boot, x=Hemisphere, split=Hemifield, col=Group)


N2_latency_Perm<-ezPerm(data = N2_latency_participant_level_long, dv = .(N2_latency), wid = .(ID),  between = .(Group), within = .(Hemifield, Hemisphere), perms = 1000)

N2_latency_Perm

ezPlot2(boot, x=Hemifield, split=Group)

```

```{r, message=FALSE}

#Show results of factorial permutation test
N2_latency_Perm

# #Plot the full design using permutated means and confidence intervals
# ezPlot2(boot, x=Hemisphere, split=Hemifield, col=Group)

#Plot the significant interaction using permutated means and confidence intervals
ezPlot2(boot, x=Hemifield, split=Group)

```

###So this ^ is a little weird, ADHD have earlier N2c peak latency for left hemifield targets than controls, even though ADHD have slower left hemifield RTs than controls 



#Go back and check RT data for Time-on-task (TOT) effects
    
    ```{r, echo=FALSE, warning=FALSE}

data2<-data[!data$LeftFixBreakneg100_100PR  &!data$RightFixBreakneg100_100PR,]


#Check for time-on-task effects:
RT_TOT<-update(RT_Hemifield, .~. + Trial)
RT_HemifieldbyTOT<-update(RT_TOT, .~. + Hemifield:Trial)
RT_GroupbyTOT<-update(RT_HemifieldbyTOT, .~. + Trial:Group)
RT_HemifieldbyGroupbyTOT<-update(RT_GroupbyTOT, .~. + Hemifield:Group:Trial)

anova(RT_HemifieldbyGroup, RT_TOT,RT_HemifieldbyTOT, RT_GroupbyTOT, RT_HemifieldbyGroupbyTOT)

```


```{r, message=FALSE, echo=FALSE, warning=FALSE}


#Plot the Hemifield x Group x TOT effect using the raw data 
ggplot(data2, aes(x=data2$Trial, y=data2$RT,fill=Hemifield,colour=Hemifield)) +
    stat_smooth(method="glm",level = 0.95,size=1) + 
    scale_fill_manual(name="Target\nHemifield",  breaks=c("Left", "Right"), labels=c(" Left", " Right"), guide = guide_legend(reverse=TRUE), values=c("red", "green")) +
    scale_colour_manual(name="Target\nHemifield",  breaks=c("Left", "Right"), labels=c(" Left", " Right"), guide = guide_legend(reverse=TRUE), values=c("red", "green")) +
    ylab("RT (ms)") +  xlab("Time On Task (200 trials)") + coord_cartesian(ylim = c(700, 900), xlim = c(-10, 200))+
    theme(axis.title.x = element_text(face="bold", size=14),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=14),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=14, face="bold")) +
    theme(legend.text = element_text(size = 12, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black"))  + facet_wrap(~ Group)

```

###Break down the signifiant TOT by Hemifield by group interaction in the RT data:

```{r, message=FALSE}
#########Break down the signifiant TOT by Hemifield by group interaction:
data2$TwoBins<-cut(data2$Trial, c(0,100,220), labels = c("First_Half", "Second_Half"))
summary(data2$TwoBins)
### For Controls, effect of target hemifield during the first half of the session:
summary(glht(lmer(log(RT) ~ Hemifield + (1 | ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2[data2$Group=="Control" & data2$TwoBins=="First_Half",], REML=FALSE, na.action = na.omit)))
### For Controls, effect of target hemifield during the 2nd half of the session:
summary(glht(lmer(log(RT) ~ Hemifield + (1 | ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2[data2$Group=="Control" & data2$TwoBins=="Second_Half",], REML=FALSE, na.action = na.omit)))

### For ADHD, effect of target hemifield during the first half of the session:
summary(glht(lmer(log(RT) ~ Hemifield + (1 | ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2[data2$Group=="ADHD" & data2$TwoBins=="First_Half",], REML=FALSE, na.action = na.omit)))
### For ADHD, effect of target hemifield during the 2nd half of the session:
summary(glht(lmer(log(RT) ~ Hemifield + (1 | ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2[data2$Group=="ADHD" & data2$TwoBins=="Second_Half",], REML=FALSE, na.action = na.omit)))

```

```{r, message=FALSE, echo=FALSE, warning=FALSE}
#Bin trials for TOT into 2 bins - First half of trials vs 2nd half 
source("summarySE.R") 
source("summarySEwithin.R") #function to calculate Std.Er of mean
source("normDataWithin.R")
plotdata <- summarySEwithin(data2, measurevar="RT", withinvars=c("Hemifield", "TwoBins"), betweenvars="Group", idvar="ID")
ggplot(plotdata, aes(x=TwoBins, y=RT, fill=Hemifield)) +
    geom_bar(position=position_dodge(.9), colour="Black", stat="identity") + 
    geom_errorbar(position=position_dodge(.9), width=.3, aes(ymin=RT-se, ymax=RT+se)) + #can change "se" to "ci" if I want to use 95%ci instead
    geom_hline(yintercept=0) +  coord_cartesian(ylim = c(700, 900)) +
    xlab("Hemifield") + ylab("RT (ms)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black")) + facet_wrap(~ Group)



```

###So this ^ shows that during the start of the task, Controls had significant pseudoneglect (left hemifield RT bias) which shifted rightward over time to no bias by the end of the task. ADHD on the other hand, had no bias at the start of the task, and showed a small (non-significant) rightward shift over time-on-task


#Look at Pre-target alpha-power over time-on-task

##Pre-alpha ROI electrodes were chosen per participant using the same post-target alpha desync method as in the Blue Light Paper
```{r, echo=FALSE, warning=FALSE}
#### Make Hemisphere a factor:
DF<-data.frame(data$ID, data$Group, data$ITI, data$Hemifield, data$PreAlphaPowerLH,data$PreAlphaPowerRH,data$Trial, data$Art_neg500_0
               , data$LeftFixBreakneg500_0 , data$RightFixBreakneg500_0 , data$Blinkneg500to0)
names(DF) <- c("ID", "Group",    "ITI",	"Hemifield","PreAlphaPowerLH","PreAlphaPowerRH","Trial", "Art_neg500_0", "LeftFixBreakneg500_0", "RightFixBreakneg500_0", "Blinkneg500to0")

DF$LeftHemi<-rep("Left",length(DF[,1]))
DF$RightHemi<-rep("Right",length(DF[,1]))               
DF_LeftHemi<-subset(DF, select=c(ID, Group, ITI, Hemifield,PreAlphaPowerLH,LeftHemi,Trial,Art_neg500_0,LeftFixBreakneg500_0,RightFixBreakneg500_0,Blinkneg500to0))
DF_RightHemi<-subset(DF, select=c(ID, Group, ITI, Hemifield,PreAlphaPowerRH,RightHemi,Trial,Art_neg500_0,LeftFixBreakneg500_0,RightFixBreakneg500_0,Blinkneg500to0))
names(DF_LeftHemi)[names(DF_LeftHemi)=="LeftHemi"] <- "Hemisphere"
names(DF_RightHemi)[names(DF_RightHemi)=="RightHemi"] <- "Hemisphere"
names(DF_LeftHemi)[names(DF_LeftHemi)=="PreAlphaPowerLH"] <- "PreAlphaPower"
names(DF_RightHemi)[names(DF_RightHemi)=="PreAlphaPowerRH"] <- "PreAlphaPower"
DF<-rbind(DF_LeftHemi,DF_RightHemi)
rm(DF_LeftHemi,DF_RightHemi)
DF$Hemisphere <- factor(DF$Hemisphere)

DF<-DF[!DF$Art_neg500_0 &!DF$Blinkneg500to0 &!DF$LeftFixBreakneg500_0 &!DF$RightFixBreakneg500_0,]

DF<-DF[DF$PreAlphaPower!=0,]

#Remove trials with missing values :
DF<-DF[complete.cases(DF),] 

DF$log_PreAlphaPower<-log(DF$PreAlphaPower) #log

#Kick out outliers
#####Z-score each participant's log_PreAlphaPower inside Hemisphere####
DF$IDbyHemisphere<-interaction(DF$ID, DF$Hemisphere) 
#calculate mean and sd 
m <- tapply(DF$log_PreAlphaPower,DF$IDbyHemisphere,mean,na.rm=T)
s <- sqrt(tapply(DF$log_PreAlphaPower,DF$IDbyHemisphere,var,na.rm=T))
#calculate log_PreAlphaPower.Z and save it inside DF.frame
DF$log_PreAlphaPower.Z <- (DF$log_PreAlphaPower-m[DF$IDbyHemisphere])/s[DF$IDbyHemisphere]
#check that Z scores have mean=0 and std=1 
log_PreAlphaPower.Z_checker <- ddply(DF, c("ID", "Hemisphere"), summarise,
                                     N    = length(log_PreAlphaPower.Z),
                                     mean = round(mean(log_PreAlphaPower.Z)),
                                     sd   = sd(log_PreAlphaPower.Z ),
                                     se   = sd / sqrt(N) )
##Remove trials where absolute log_PreAlphaPower.Z>3 (i.e. remove outlier log_PreAlphaPowers)
DF<-DF[!abs(DF$log_PreAlphaPower.Z)>3,]

# REML=FALSE,

cat("Number of Observations for modle:")
print(dim(DF)[1])


############ Modle the effects of Group, and Hemisphere on Pre-target Alpha Power ########### 
PreAlphaPower_random_intercepts_only<-lmer(log(PreAlphaPower) ~ 1 + (1 | ID/Hemisphere) +(1|ITI) + (1|Trial), data = DF,  na.action = na.omit, REML=F)
PreAlphaPower_Group<-update(PreAlphaPower_random_intercepts_only, .~. + Group)
PreAlphaPower_Hemisphere<-update(PreAlphaPower_Group, .~. + Hemisphere)
PreAlphaPower_GroupbyHemisphere<-update(PreAlphaPower_Hemisphere, .~. + Group*Hemisphere)
PreAlphaPower_TOT<-update(PreAlphaPower_GroupbyHemisphere, .~. + Trial)
PreAlphaPower_GroupbyTOT <- update(PreAlphaPower_TOT, .~. + Group*Trial)
PreAlphaPower_HemispherebyTOT <- update(PreAlphaPower_GroupbyTOT, .~. + Hemisphere*Trial)
PreAlphaPower_GroupbyHemispherebyTOT<-update(PreAlphaPower_HemispherebyTOT, .~. + Group*Hemisphere*Trial)

anova(PreAlphaPower_random_intercepts_only, PreAlphaPower_Group,PreAlphaPower_Hemisphere,PreAlphaPower_GroupbyHemisphere,PreAlphaPower_TOT,PreAlphaPower_GroupbyTOT, PreAlphaPower_HemispherebyTOT, PreAlphaPower_GroupbyHemispherebyTOT)
```
**This ^ shows there is a significant Group x Hemisphere x TOT interaction. Lets plot it:**

```{r, echo=FALSE, warning=FALSE}

require(effects)
eff.GroupbyHemispherebyTOT <- Effect(c("Group", "Hemisphere", "Trial"), PreAlphaPower_GroupbyHemispherebyTOT)

plot(eff.GroupbyHemispherebyTOT, layout=c(2,1), main=NULL, rug=F, multiline =T, alternating=T, z.var="Hemisphere", ticks.x=NULL,ylim=c(0.9,1.16), xlab="Time-on-task (trial)", ylab="Alpha Power (uV)")
```

**This plot ^ shows ADHD have a rightward shift in hemispheric alpha asymmetry with TOT, driven by increasing right hemisphere alpha power over time**


###Break down the sinigicant Group by Hemisphere by TOT interaction in pre-target alpha power:
```{r, echo=FALSE, warning=FALSE}
##
#### Break down the sinigicant Group*Hemisphere*TOT interaction:
##

contrast.matrix_HemispherebyTOT<-rbind(
    "LeftHemisphere:TOT vs RightHemisphere:TOT"  =c(0,0,0,1))

#Test for Hemisphere*TOT effect in Controls only
PreAlphaPower_random_intercepts_only_Control<-lmer(log(PreAlphaPower) ~ 1 + (1 | ID/Hemisphere) +(1|ITI) + (1|Trial), data = DF[DF$Group=="Control",],  na.action = na.omit, REML=F)
PreAlphaPower_Hemisphere_Control<-update(PreAlphaPower_random_intercepts_only_Control, .~. + Hemisphere)
PreAlphaPower_TOT_Control<-update(PreAlphaPower_Hemisphere_Control, .~. + Trial)
PreAlphaPower_HemispherebyTOT_Control <- update(PreAlphaPower_TOT_Control, .~. + Hemisphere*Trial)
anova(PreAlphaPower_random_intercepts_only_Control, PreAlphaPower_Hemisphere_Control, PreAlphaPower_TOT_Control, PreAlphaPower_HemispherebyTOT_Control)

#Test for Hemisphere*TOT effect in ADHD only
PreAlphaPower_random_intercepts_only_ADHD<-lmer(log(PreAlphaPower) ~ 1 + (1 | ID/Hemisphere) +(1|ITI) + (1|Trial), data = DF[DF$Group=="ADHD",],  na.action = na.omit, REML=F)
PreAlphaPower_Hemisphere_ADHD<-update(PreAlphaPower_random_intercepts_only_ADHD, .~. + Hemisphere)
PreAlphaPower_TOT_ADHD<-update(PreAlphaPower_Hemisphere_ADHD, .~. + Trial)
PreAlphaPower_HemispherebyTOT_ADHD <- update(PreAlphaPower_TOT_ADHD, .~. + Hemisphere*Trial)
anova(PreAlphaPower_random_intercepts_only_ADHD, PreAlphaPower_Hemisphere_ADHD, PreAlphaPower_TOT_ADHD, PreAlphaPower_HemispherebyTOT_ADHD)

```

###SO, only ADHD have a significant Hemisphere*TOT effect:
```{r, echo=FALSE, warning=FALSE}
#ADHD
summary(glht(PreAlphaPower_HemispherebyTOT_ADHD, contrast.matrix_HemispherebyTOT))
#Control
summary(glht(PreAlphaPower_HemispherebyTOT_Control, contrast.matrix_HemispherebyTOT))

```

```{r, message=FALSE, echo=FALSE, warning=FALSE, include=FALSE}

##Check assumptions for  model by plotting residuals:
residuals_PreAlphaPower_GroupbyHemispherebyTOT=residuals(PreAlphaPower_GroupbyHemispherebyTOT)
plot(residuals_PreAlphaPower_GroupbyHemispherebyTOT)
qqnorm(residuals_PreAlphaPower_GroupbyHemispherebyTOT)
qqline(residuals_PreAlphaPower_GroupbyHemispherebyTOT)
hist(residuals_PreAlphaPower_GroupbyHemispherebyTOT)

```



###Plot Alpha Asymmetry Index by TOT and Group help look at significant Group x Hemisphere x TOT interaction in the alpha power data

```{r, message=FALSE, echo=FALSE}
#Have a look at the effect of time-on-task on pre-target alpha asymmetry between ADHD and Controls 

data2<-data[!data$Art_neg500_0 &!data$Blinkneg500to0 &!data$LeftFixBreakneg500_0 &!data$RightFixBreakneg500_0,]

ggplot(data2, aes(x=data2$Trial, y=data2$PreAlphaAsym)) +
    stat_smooth(method="glm",level = 0.95,size=1) + #
    facet_wrap(~ Group)
```


**So ADHD have a significant rightward shift in hemispheric alpha asymmetry with TOT, while ADHD do not. Above shows ADHD's rightward shift is driven by increasing right hemisphere alpha power over time**

###Post-target alpha desynchronisation

**Measured from 300-1000ms post target from participant level alpha traces in matlab baselined from -500-0ms
```{r, message=FALSE, echo=FALSE}
##Try the old ANOVA approach using AlphaDesync measured from Participant level traces rather than single trial traces

#Reshape participant_level into long format for modeling with lmw4:
AlphaDesync_participant_level_long <- melt(participant_level, id.vars=c("ID", "Gender", "Group", "Age", "DAT1_3UTR"), 
                                  measure.vars=c("AlphaDesync_RightHemi_LeftTarget", "AlphaDesync_LeftHemi_RightTarget", "AlphaDesync_LeftHemi_LeftTarget", "AlphaDesync_RightHemi_RightTarget" ), 
                                  variable.name="Hemifield_by_Hemisphere",
                                  value.name="AlphaDesync")
#Create seperate target Hemifield and Hemisphere factors
AlphaDesync_participant_level_long$Hemifield<-revalue(AlphaDesync_participant_level_long$Hemifield_by_Hemisphere, c("AlphaDesync_RightHemi_LeftTarget"="Left","AlphaDesync_LeftHemi_LeftTarget"="Left", "AlphaDesync_LeftHemi_RightTarget"="Right", "AlphaDesync_RightHemi_RightTarget"="Right"))
AlphaDesync_participant_level_long$Hemisphere<-revalue(AlphaDesync_participant_level_long$Hemifield_by_Hemisphere, c("AlphaDesync_RightHemi_LeftTarget"="Contralateral","AlphaDesync_LeftHemi_LeftTarget"="Ipsilateral", "AlphaDesync_LeftHemi_RightTarget"="Contralateral", "AlphaDesync_RightHemi_RightTarget"="Ipsilateral"))

ezANOVA(
    data = AlphaDesync_participant_level_long
    , dv = .(AlphaDesync)
    , wid = .(ID)
    , within = .(Hemifield, Hemisphere)
    , between = .(Group)
    , observed = .(Group, Hemisphere)
    , type = 3
    , detailed = F
)

ezPerm(
    data = AlphaDesync_participant_level_long
    , dv = .(AlphaDesync)
    , wid = .(ID)
    , within = .(Hemifield, Hemisphere)
    , between = .(Group)
)

AlphaDesync_boot<-ezBoot(data = AlphaDesync_participant_level_long
                         , dv = .(AlphaDesync)
                         , wid = .(ID)
                         , within = .(Hemifield, Hemisphere)
                         , between = .(Group)
                         , resample_within=F)

ezPlot2(AlphaDesync_boot, x=Hemifield, split=Group)




```


#Any effect of TOT on N2 amplitude?
```{r, message=FALSE, echo=FALSE}
#Make Hemisphere a factor:
DF<-data.frame(data$ID, data$ITI, data$Hemifield, data$N2c_PA,data$N2i_PA, data$Trial, data$Blinkneg100_450, data$LeftFixBreakneg100_450, data$RightFixBreakneg100_450, data$Art_neg100_450, data$BothFixBreakneg100_450, data$Group)

names(DF) <- c("ID",  "ITI",	"Hemifield","N2c_PA","N2i_PA","Trial","Blinkneg100_450", 
               "LeftFixBreakneg100_450", "RightFixBreakneg100_450", "Art_neg100_450", "BothFixBreakneg100_450", "Group")



DF$contralateral<-rep("contralateral",length(DF[,1]))
DF$ipsilateral<-rep("ipsilateral",length(DF[,1]))               
DF_contralateral<-subset(DF, select=c(ID, ITI, Hemifield,N2c_PA,contralateral,Trial,Blinkneg100_450, 
                                      LeftFixBreakneg100_450, RightFixBreakneg100_450, Art_neg100_450, BothFixBreakneg100_450,Group))
DF_ipsilateral<-subset(DF, select=c(ID, ITI, Hemifield,N2i_PA,ipsilateral,Trial,Blinkneg100_450, 
                                    LeftFixBreakneg100_450, RightFixBreakneg100_450, Art_neg100_450, BothFixBreakneg100_450,Group))

names(DF_contralateral)[names(DF_contralateral)=="contralateral"] <- "Hemisphere"
names(DF_ipsilateral)[names(DF_ipsilateral)=="ipsilateral"] <- "Hemisphere"
names(DF_contralateral)[names(DF_contralateral)=="N2c_PA"] <- "N2"
names(DF_ipsilateral)[names(DF_ipsilateral)=="N2i_PA"] <- "N2"
DF<-rbind(DF_contralateral,DF_ipsilateral)
rm(DF_contralateral,DF_ipsilateral)
DF$Hemisphere <- factor(DF$Hemisphere)

DF<-DF[!DF$Blinkneg100_450 & !DF$LeftFixBreakneg100_450 & !DF$RightFixBreakneg100_450 & !DF$Art_neg100_450 & !DF$BothFixBreakneg100_450, ]


DF$IDbyHemifieldbyITIbyHemispherebyHemisphere<-interaction(DF$ID, DF$Hemifield, DF$ITI, DF$Hemisphere)
#calculate mean and sd 
m <- tapply(DF$N2,DF$IDbyHemifieldbyITIbyHemisphere,mean)
s <- sqrt(tapply(DF$N2,DF$IDbyHemifieldbyITIbyHemisphere,var))
#calculate N2.Z and save it inside data.frame
DF$N2.Z <- (DF$N2-m[DF$IDbyHemifieldbyITIbyHemisphere])/s[DF$IDbyHemifieldbyITIbyHemisphere]
#check that Z scores have mean=0 and std=1 
N2.Z_checker <- ddply(DF, c("ID", "Hemifield", "ITI", "Hemisphere"), summarise,
                      N    = length(N2.Z ),
                      mean = round(mean(N2.Z )),
                      sd   = sd(N2.Z ),
                      se   = sd / sqrt(N))

##Remove trials where absolute N2.Z>3 (i.e. remove outlier N2s)
DF<-DF[!abs(DF$N2.Z)>3,]


## NO EFFECTS OF TOT on N2:
##Check for TOT effects:
N2_TOT<-update(N2_HemifieldbyGroupbyHemisphere, .~. + Trial)
N2_GroupbyTOT<-update(N2_TOT, .~. + Trial*Group)
N2_HemifieldbyTOT<-update(N2_GroupbyTOT, .~. + Trial*Hemifield)
N2_HemispherebyTOT<-update(N2_HemifieldbyTOT, .~. + Trial*Hemisphere)
N2_HemifieldbyGroupbyTOT<-update(N2_HemispherebyTOT, .~. + Trial*Hemifield*Group)
N2_HemispherebyGroupbyTOT<-update(N2_HemifieldbyGroupbyTOT, .~. + Trial*Hemisphere*Group)
N2_HemifieldbyHemispherebyTOT<-update(N2_HemispherebyGroupbyTOT, .~. + Trial*Hemisphere*Hemifield)
N2_HemifieldbyGroupbyHemispherebyTOT<-update(N2_HemifieldbyHemispherebyTOT, .~. + Trial*Hemisphere*Hemifield*Group)
anova(N2_HemifieldbyGroupbyHemisphere, N2_TOT, N2_GroupbyTOT, N2_HemifieldbyTOT,N2_HemispherebyTOT,N2_HemifieldbyGroupbyTOT,N2_HemispherebyGroupbyTOT,N2_HemifieldbyHemispherebyTOT,N2_HemifieldbyGroupbyHemispherebyTOT)
```
##No the effect ^ of TOT on N2 amplitude


############################################################################################################
############################################################################################################
############################################################################################################
############################################################################################################
############################################################################################################
############################################################################################################
#Single trial AlphaDesync Amplitude 

###AlphaDesync_c/i measurement window (100ms) was centred on peak amplitude of each INDIVIDUAL PARTICIANT's AVERAGE AlphaDesync_c/i waveforms:

```{r, echo=FALSE, message=FALSE}

#Make Hemisphere a factor:
DF<-dplyr::select(data, ID, ITI, Hemifield, AlphaDesync_c, AlphaDesync_i, Trial, Blinkneg100_100PR, LeftFixBreakneg100_100PR, RightFixBreakneg100_100PR, Art_neg100_100PR, BothFixBreakneg100_100PR, Group, Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh)

DF$contralateral<-rep("contralateral",length(DF[,1]))
DF$ipsilateral<-rep("ipsilateral",length(DF[,1]))               
DF_contralateral<-subset(DF, select=c(ID, ITI, Hemifield,AlphaDesync_c,contralateral,Trial,Blinkneg100_100PR, 
                                      LeftFixBreakneg100_100PR, RightFixBreakneg100_100PR, Art_neg100_100PR, BothFixBreakneg100_100PR,Group,
                                      Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh))
DF_ipsilateral<-subset(DF, select=c(ID, ITI, Hemifield,AlphaDesync_i,ipsilateral,Trial,Blinkneg100_100PR, 
                                    LeftFixBreakneg100_100PR, RightFixBreakneg100_100PR, Art_neg100_100PR, BothFixBreakneg100_100PR,Group,
                                    Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh))

names(DF_contralateral)[names(DF_contralateral)=="contralateral"] <- "Hemisphere"
names(DF_ipsilateral)[names(DF_ipsilateral)=="ipsilateral"] <- "Hemisphere"
names(DF_contralateral)[names(DF_contralateral)=="AlphaDesync_c"] <- "AlphaDesync"
names(DF_ipsilateral)[names(DF_ipsilateral)=="AlphaDesync_i"] <- "AlphaDesync"
DF<-rbind(DF_contralateral,DF_ipsilateral)
rm(DF_contralateral,DF_ipsilateral)
DF$Hemisphere <- factor(DF$Hemisphere)

DF<-DF[!DF$Blinkneg100_100PR & !DF$LeftFixBreakneg100_100PR & !DF$RightFixBreakneg100_100PR & !DF$Art_neg100_100PR & !DF$BothFixBreakneg100_100PR, ]


DF$IDbyHemifieldbyITIbyHemispherebyHemisphere<-interaction(DF$ID, DF$Hemifield, DF$ITI, DF$Hemisphere)
#calculate mean and sd 
m <- tapply(DF$AlphaDesync,DF$IDbyHemifieldbyITIbyHemisphere,mean)
s <- sqrt(tapply(DF$AlphaDesync,DF$IDbyHemifieldbyITIbyHemisphere,var))
#calculate AlphaDesync.Z and save it inside data.frame
DF$AlphaDesync.Z <- (DF$AlphaDesync-m[DF$IDbyHemifieldbyITIbyHemisphere])/s[DF$IDbyHemifieldbyITIbyHemisphere]
#check that Z scores have mean=0 and std=1 
AlphaDesync.Z_checker <- ddply(DF, c("ID", "Hemifield", "ITI", "Hemisphere"), summarise,
                               N    = length(AlphaDesync.Z ),
                               mean = round(mean(AlphaDesync.Z )),
                               sd   = sd(AlphaDesync.Z ),
                               se   = sd / sqrt(N))

##Remove trials where absolute AlphaDesync.Z>3 (i.e. remove outlier AlphaDesyncs)
DF<-DF[!abs(DF$AlphaDesync.Z)>3,]

# hist_AlphaDesync<-ggplot(DF, aes(AlphaDesync))  + geom_histogram(aes(y=..count..), colour="black", fill="white") 
# hist_AlphaDesync + facet_wrap(~ ID)
# hist(DF$AlphaDesync)

###Run the mixed model  
AlphaDesync_random_intercepts_only<-lmer(AlphaDesync ~ 1 + (1 | ID/Hemisphere) +(1|ITI) + (1|Hemifield) + (1|Trial), data = DF, REML=FALSE, na.action = na.omit)
AlphaDesync_Group<-update(AlphaDesync_random_intercepts_only, .~. + Group)
AlphaDesync_Hemifield<-update(AlphaDesync_Group, .~. + Hemifield)
AlphaDesync_Hemisphere<-update(AlphaDesync_Hemifield, .~. + Hemisphere)
AlphaDesync_HemifieldbyGroup<-update(AlphaDesync_Hemisphere, .~. + Hemifield:Group)
AlphaDesync_HemispherebyGroup<-update(AlphaDesync_HemifieldbyGroup, .~. + Hemisphere:Group)
AlphaDesync_HemifieldbyHemisphere<-update(AlphaDesync_HemispherebyGroup, .~. + Hemisphere:Hemifield)
AlphaDesync_HemifieldbyGroupbyHemisphere<-update(AlphaDesync_HemifieldbyHemisphere, .~. + Hemifield:Group:Hemisphere)
anova(AlphaDesync_random_intercepts_only, AlphaDesync_Group, AlphaDesync_Hemifield, AlphaDesync_Hemisphere, AlphaDesync_HemifieldbyGroup, AlphaDesync_HemispherebyGroup, AlphaDesync_HemifieldbyHemisphere, AlphaDesync_HemifieldbyGroupbyHemisphere)



AlphaDesync_random_effects_only<-lmer(AlphaDesync ~ 1 + (Hemifield | ID/Hemisphere) +(1|ITI) + (1|Trial), data = DF, REML=FALSE, na.action = na.omit)
AlphaDesync_Group<-update(AlphaDesync_random_effects_only, .~. + Group)
AlphaDesync_Hemifield<-update(AlphaDesync_Group, .~. + Hemifield)
AlphaDesync_Hemisphere<-update(AlphaDesync_Hemifield, .~. + Hemisphere)
AlphaDesync_HemifieldbyGroup<-update(AlphaDesync_Hemisphere, .~. + Hemifield:Group)
AlphaDesync_HemispherebyGroup<-update(AlphaDesync_HemifieldbyGroup, .~. + Hemisphere:Group)
AlphaDesync_HemifieldbyHemisphere<-update(AlphaDesync_HemispherebyGroup, .~. + Hemisphere:Hemifield)
AlphaDesync_HemifieldbyGroupbyHemisphere<-update(AlphaDesync_HemifieldbyHemisphere, .~. + Hemifield:Group:Hemisphere)
anova(AlphaDesync_random_effects_only, AlphaDesync_Group, AlphaDesync_Hemifield, AlphaDesync_Hemisphere, AlphaDesync_HemifieldbyGroup, AlphaDesync_HemispherebyGroup, AlphaDesync_HemifieldbyHemisphere, AlphaDesync_HemifieldbyGroupbyHemisphere)

```



#Single trial PostAlpha Amplitude 

###PostAlpha_c/i measurement window (100ms) was centred on peak amplitude of each INDIVIDUAL PARTICIANT's AVERAGE PostAlpha_c/i waveforms:

```{r, echo=FALSE, message=FALSE}

#Make Hemisphere a factor:
DF<-dplyr::select(data, ID, ITI, Hemifield, PostAlpha_c, PostAlpha_i, Trial, Blinkneg100_100PR, LeftFixBreakneg100_100PR, RightFixBreakneg100_100PR, Art_neg100_100PR, BothFixBreakneg100_100PR, Group, Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh)

DF$contralateral<-rep("contralateral",length(DF[,1]))
DF$ipsilateral<-rep("ipsilateral",length(DF[,1]))               
DF_contralateral<-subset(DF, select=c(ID, ITI, Hemifield,PostAlpha_c,contralateral,Trial,Blinkneg100_100PR, 
                                      LeftFixBreakneg100_100PR, RightFixBreakneg100_100PR, Art_neg100_100PR, BothFixBreakneg100_100PR,Group,
                                      Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh))
DF_ipsilateral<-subset(DF, select=c(ID, ITI, Hemifield,PostAlpha_i,ipsilateral,Trial,Blinkneg100_100PR, 
                                    LeftFixBreakneg100_100PR, RightFixBreakneg100_100PR, Art_neg100_100PR, BothFixBreakneg100_100PR,Group,
                                    Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh))

names(DF_contralateral)[names(DF_contralateral)=="contralateral"] <- "Hemisphere"
names(DF_ipsilateral)[names(DF_ipsilateral)=="ipsilateral"] <- "Hemisphere"
names(DF_contralateral)[names(DF_contralateral)=="PostAlpha_c"] <- "PostAlpha"
names(DF_ipsilateral)[names(DF_ipsilateral)=="PostAlpha_i"] <- "PostAlpha"
DF<-rbind(DF_contralateral,DF_ipsilateral)
rm(DF_contralateral,DF_ipsilateral)
DF$Hemisphere <- factor(DF$Hemisphere)

DF<-DF[!DF$Blinkneg100_100PR & !DF$LeftFixBreakneg100_100PR & !DF$RightFixBreakneg100_100PR & !DF$Art_neg100_100PR & !DF$BothFixBreakneg100_100PR, ]


DF$IDbyHemifieldbyITIbyHemispherebyHemisphere<-interaction(DF$ID, DF$Hemifield, DF$ITI, DF$Hemisphere)
#calculate mean and sd 
m <- tapply(DF$PostAlpha,DF$IDbyHemifieldbyITIbyHemisphere,mean)
s <- sqrt(tapply(DF$PostAlpha,DF$IDbyHemifieldbyITIbyHemisphere,var))
#calculate PostAlpha.Z and save it inside data.frame
DF$PostAlpha.Z <- (DF$PostAlpha-m[DF$IDbyHemifieldbyITIbyHemisphere])/s[DF$IDbyHemifieldbyITIbyHemisphere]
#check that Z scores have mean=0 and std=1 
PostAlpha.Z_checker <- ddply(DF, c("ID", "Hemifield", "ITI", "Hemisphere"), summarise,
                               N    = length(PostAlpha.Z ),
                               mean = round(mean(PostAlpha.Z )),
                               sd   = sd(PostAlpha.Z ),
                               se   = sd / sqrt(N))

##Remove trials where absolute PostAlpha.Z>3 (i.e. remove outlier PostAlphas)
DF<-DF[!abs(DF$PostAlpha.Z)>3,]

# hist_PostAlpha<-ggplot(DF, aes(PostAlpha))  + geom_histogram(aes(y=..count..), colour="black", fill="white") 
# hist_PostAlpha + facet_wrap(~ ID)
# hist(DF$PostAlpha)

###Run the mixed model  
PostAlpha_random_intercepts_only<-lmer(PostAlpha ~ 1 + (1 | ID/Hemisphere) +(1|ITI) + (1|Hemifield) + (1|Trial), data = DF, REML=FALSE, na.action = na.omit)
PostAlpha_Group<-update(PostAlpha_random_intercepts_only, .~. + Group)
PostAlpha_Hemifield<-update(PostAlpha_Group, .~. + Hemifield)
PostAlpha_Hemisphere<-update(PostAlpha_Hemifield, .~. + Hemisphere)
PostAlpha_HemifieldbyGroup<-update(PostAlpha_Hemisphere, .~. + Hemifield:Group)
PostAlpha_HemispherebyGroup<-update(PostAlpha_HemifieldbyGroup, .~. + Hemisphere:Group)
PostAlpha_HemifieldbyHemisphere<-update(PostAlpha_HemispherebyGroup, .~. + Hemisphere:Hemifield)
PostAlpha_HemifieldbyGroupbyHemisphere<-update(PostAlpha_HemifieldbyHemisphere, .~. + Hemifield:Group:Hemisphere)
anova(PostAlpha_random_intercepts_only, PostAlpha_Group, PostAlpha_Hemifield, PostAlpha_Hemisphere, PostAlpha_HemifieldbyGroup, PostAlpha_HemispherebyGroup, PostAlpha_HemifieldbyHemisphere, PostAlpha_HemifieldbyGroupbyHemisphere)



PostAlpha_random_effects_only<-lmer(PostAlpha ~ 1 + (Hemifield | ID/Hemisphere) +(1|ITI) + (1|Trial), data = DF, REML=FALSE, na.action = na.omit)
PostAlpha_Group<-update(PostAlpha_random_effects_only, .~. + Group)
PostAlpha_Hemifield<-update(PostAlpha_Group, .~. + Hemifield)
PostAlpha_Hemisphere<-update(PostAlpha_Hemifield, .~. + Hemisphere)
PostAlpha_HemifieldbyGroup<-update(PostAlpha_Hemisphere, .~. + Hemifield:Group)
PostAlpha_HemispherebyGroup<-update(PostAlpha_HemifieldbyGroup, .~. + Hemisphere:Group)
PostAlpha_HemifieldbyHemisphere<-update(PostAlpha_HemispherebyGroup, .~. + Hemisphere:Hemifield)
PostAlpha_HemifieldbyGroupbyHemisphere<-update(PostAlpha_HemifieldbyHemisphere, .~. + Hemifield:Group:Hemisphere)
anova(PostAlpha_random_effects_only, PostAlpha_Group, PostAlpha_Hemifield, PostAlpha_Hemisphere, PostAlpha_HemifieldbyGroup, PostAlpha_HemispherebyGroup, PostAlpha_HemifieldbyHemisphere, PostAlpha_HemifieldbyGroupbyHemisphere)

```
############################################################################################################
############################################################################################################
############################################################################################################
############################################################################################################
############################################################################################################
############################################################################################################
############################################################################################################
############################################################################################################



#Test how clinical measures relate to Asymmetry Indices and other variables of interest: 

```{r, echo=FALSE, warning=FALSE}

#Change CPP onset scores of 0 to NA
participant_level$CPPonset_LeftTarget[participant_level$CPPonset_LeftTarget==0]<-NA
participant_level$CPPonset_RightTarget[participant_level$CPPonset_RightTarget==0]<-NA

#####Calculate PreAlpha Asym#####
participant_level$PreAlpha_Asym<-(participant_level$PreAlpha_RightHemi-participant_level$PreAlpha_LeftHemi)/(participant_level$PreAlpha_RightHemi+participant_level$PreAlpha_LeftHemi)
#####Calculate N2c_GA Asym#####
participant_level$N2c_GA_Asym<-(participant_level$N2c_LeftTarget_GA-participant_level$N2c_RightTarget_GA)/(participant_level$N2c_LeftTarget_GA+participant_level$N2c_RightTarget_GA)
#####Calculate N2c_PA Asym#####
participant_level$N2c_PA_Asym<-(participant_level$N2c_LeftTarget_PA-participant_level$N2c_RightTarget_PA)/(participant_level$N2c_LeftTarget_PA+participant_level$N2c_RightTarget_PA)
#####Calculate N2i_GA Asym#####
participant_level$N2i_GA_Asym<-(participant_level$N2i_LeftTarget_GA-participant_level$N2i_RightTarget_GA)/(participant_level$N2i_LeftTarget_GA+participant_level$N2i_RightTarget_GA)
#####Calculate N2i_PA Asym#####
participant_level$N2i_PA_Asym<-(participant_level$N2i_LeftTarget_PA-participant_level$N2i_RightTarget_PA)/(participant_level$N2i_LeftTarget_PA+participant_level$N2i_RightTarget_PA)
#####Calculate N2c_latency_Asym#####
participant_level$N2c_latency_Asym<-(participant_level$N2c_latency_LeftTarget-participant_level$N2c_latency_RightTarget)/(participant_level$N2c_latency_LeftTarget+participant_level$N2c_latency_RightTarget)
#####Calculate N2i_latency_Asym#####
participant_level$N2i_latency_Asym<-(participant_level$N2i_latency_LeftTarget-participant_level$N2i_latency_RightTarget)/(participant_level$N2i_latency_LeftTarget+participant_level$N2i_latency_RightTarget)
#####Calculate Contralateral Alpha Desync Asym#####
participant_level$Contra_AlphaDesync_Asym<-(participant_level$AlphaDesync_RightHemi_LeftTarget-participant_level$AlphaDesync_LeftHemi_RightTarget)/(participant_level$AlphaDesync_RightHemi_LeftTarget+participant_level$AlphaDesync_LeftHemi_RightTarget)
#####Calculate Ipsilateral Alpha Desync Asym#####
participant_level$Ipsi_AlphaDesync_Asym<-(participant_level$AlphaDesync_LeftHemi_LeftTarget-participant_level$AlphaDesync_RightHemi_RightTarget)/(participant_level$AlphaDesync_LeftHemi_LeftTarget+participant_level$AlphaDesync_RightHemi_RightTarget)
#####Calculate CPP onset Asym#####
participant_level$CPPonset_Asym<-(participant_level$CPPonset_LeftTarget-participant_level$CPPonset_RightTarget)/(participant_level$CPPonset_LeftTarget+participant_level$CPPonset_RightTarget)
#####Calculate CPP Slope Asym#####
participant_level$CPPslope_Asym<-(participant_level$CPPslope_LeftTarget-participant_level$CPPslope_RightTarget)/(participant_level$CPPslope_LeftTarget+participant_level$CPPslope_RightTarget)



# 
# fit <- lm(RT_Asym ~ PreAlpha_Asym + N2c_PA_Asym + N2i_PA_Asym + CPPonset_Asym + N2c_latency_Asym + N2i_latency_Asym + CPPslope_Asym, data=participant_level)
# summary(fit)
# 
# fit <- lm(RT_Asym ~ CPPonset_Asym, data=participant_level)
# summary(fit)
# 
# require(Hmisc)
# 
# rcorr(as.matrix(participant_level[c("RT_Asym", "PreAlpha_Asym", "N2c_PA_Asym", "N2i_PA_Asym", "CPPonset_Asym", "N2c_latency_Asym", "N2i_latency_Asym", "CPPslope_Asym")]))
# 
# cor(as.matrix(participant_level[c("RT_Asym", "PreAlpha_Asym", "N2c_PA_Asym", "N2i_PA_Asym", "CPPonset_Asym", "N2c_latency_Asym", "N2i_latency_Asym", "CPPslope_Asym")]), use="complete.obs")
# 
# 
# #### Look at relationship between N2c/i measured using window based on Grand Average vs. Window based on Participant Average
# require(Hmisc)
# rcorr(participant_level$N2c_LeftTarget_GA, participant_level$N2c_LeftTarget_PA, type=c("pearson"))
# plot(participant_level$N2c_LeftTarget_GA, participant_level$N2c_LeftTarget_PA)
# 
# rcorr(participant_level$N2c_RightTarget_GA, participant_level$N2c_RightTarget_PA, type=c("pearson"))
# plot(participant_level$N2c_RightTarget_GA, participant_level$N2c_RightTarget_PA)
# 
# rcorr(participant_level$N2i_LeftTarget_GA, participant_level$N2i_LeftTarget_PA, type=c("pearson"))
# plot(participant_level$N2i_LeftTarget_GA, participant_level$N2i_LeftTarget_PA)
# 
# rcorr(participant_level$N2i_RightTarget_GA, participant_level$N2i_RightTarget_PA, type=c("pearson"))
# plot(participant_level$N2i_RightTarget_GA, participant_level$N2i_RightTarget_PA)


# #############Play around with plotting Correlation heatmaps#####################
# 
# cor_matrix<-cor(as.matrix(participant_level[c("RT_Asym", "PreAlpha_Asym", "N2c_PA_Asym", "N2i_PA_Asym", "CPPonset_Asym", "N2c_latency_Asym", "N2i_latency_Asym", "CPPslope_Asym", "N2c_GA_Asym", "N2i_GA_Asym")]), use="complete.obs")
# qplot(x=Var1, y=Var2, data=melt(cor_matrix), fill=value, geom="tile") + theme(axis.text.x=element_text(angle=-90))
# 
# #Try it on the single trial measures:
# cor_matrix<-cor(as.matrix(data2[c("RT", "PreAlphaPowerLH", "PreAlphaPowerRH", "PreAlphaAsym", "PrePupilDiameter", "N2c_GA", "N2i_GA", "RespLockedCPPSlope", "N2cPeakLatency", "CPPHalfPeakLatency", "N2c_PA", "N2i_PA")]), use="complete.obs")
# qplot(x=Var1, y=Var2, data=melt(cor_matrix), fill=value, geom="tile")+ scale_fill_gradient(low="green", high="red") + theme(axis.text.x=element_text(angle=-90))


require(Hmisc)
#Select only the columns that are numeric
nums <- sapply(participant_level, is.numeric)
data2<-participant_level[ , nums]


#Only keep columns I'm interested in:
keeps <- c("RT_Asym", "PreAlpha_Asym", "N2c_PA_Asym", "N2i_PA_Asym", "CPPonset_Asym", "N2c_latency_Asym", "N2i_latency_Asym", "CPPslope_Asym", "N2c_GA_Asym", "N2i_GA_Asym",
    "CPPonset_LeftTarget",               "CPPonset_RightTarget",          
    "CPPslope_LeftTarget",               "CPPslope_RightTarget",              "Group",                     
    "N2c_LeftTarget_PA",                 "N2c_RightTarget_PA",                "N2i_LeftTarget_PA",                 "N2i_RightTarget_PA",                "HQ_B",                 "eFSIQ_B",                           "Vocab_Scaled_B",                                          
    "Read_Standard_B",                   "Spell_Standard_B",                  "AQ_Tot_B",
    "CPRS_H_B",                          "Accuracy_LeftTargets",              "Accuracy_RightTargets",             "Accuracy_asym")
data2<-data2[keeps]



#Make a function to find the critical r value (for significane) given n and alpha
critical.r <- function( n, alpha = .05 ) {
    df <- n - 2
    critical.t <- qt(alpha/2, df, lower.tail = F)
    critical.r <- sqrt( (critical.t^2) / ( (critical.t^2) + df ) )
    return(critical.r)
}
# Example usage: Critical correlation coefficient at sample size of n = 100
critical.r(n=50, alpha = .05)

```

###Plot correlation heatmap of some variables of interest, keeping only those relationships with uncorrected p<.05

**NOTE: for the N2c/i the "_PA" or "_GA" represents whether the N2 measurement window was based on peak amplitude of individual participant's wavefore, or the Grand Average Waveform.** 
```{r, echo=FALSE, warning=FALSE}
#make a dataframe of r (correlation coefficient) values to plot
cor_matrix<-cor(as.matrix(data2), use="na.or.complete")
cor_data<-melt(cor_matrix)
require(plyr)
cor_data<-rename(cor_data, c("value"="Pearson_r"))
cor_data$abs_Pearson_r<-abs(cor_data$Pearson_r)
#Only keep relationships that have r Pearson_r greater than the uncorrected r critical value
cor_data<-cor_data[abs(cor_data$Pearson_r)>critical.r(n=dim(data2)[1], alpha = .05),]

####Plot:
qplot(x=Var1, y=Var2, data=cor_data, fill=Pearson_r, geom="tile")+ 
    theme(axis.title.x = element_text(face="bold", size=9),
          axis.text.x  = element_text(face="bold", angle=-90,  size=9)) +
    theme(axis.title.y = element_text(face="bold", size=9),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) 
```

**Try same thing but plotting absolute r value (from 0 to 1; instead of from -1 to 1 as in the plot above)**
```{r, echo=FALSE, warning=FALSE}
#Try graphing the absolute r value (rather than +/-)
qplot(x=Var1, y=Var2, data=cor_data, fill=abs_Pearson_r, geom="tile")+ 
    theme(axis.title.x = element_text(face="bold", size=9),
          axis.text.x  = element_text(face="bold", angle=-90,  size=9)) +
    theme(axis.title.y = element_text(face="bold", size=9),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=9)) 


```


##Single trial CPP onset

```{r, echo=FALSE, warning=FALSE}

#remove trials with blinks, artifacts etc and also remove trials witn CPPonset==0 as these are not valid 
#("9999" are NaNs made it "9999" in MATLAB because R won't read NaNs from .csv file)
require(dplyr)
data2<- filter(data, !Blinkneg100_100PR & !LeftFixBreakneg100_100PR & !RightFixBreakneg100_100PR & !Art_neg100_100PR & !BothFixBreakneg100_100PR & CPPonset!=0 & CPPonset<1500)

#add 100 to every CPP onset measure, just shifts the distribution 
#100ms to the right so there are no negitive measures so we can 
#do sqrt and log transformations 
data2$CPPonset=data2$CPPonset+100 


hist(data2$CPPonset)
hist(data2$CPPonset, breaks=625,xlim=c(-100,1500))

hist(sqrt(data2$CPPonset))

hist(log(data2$CPPonset))

#
CPPonset_random_intercepts_only<-lmer(sqrt(CPPonset) ~ 1 + (1 | ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2, REML=FALSE, na.action = na.omit)
CPPonset_Group<-update(CPPonset_random_intercepts_only, .~. + Group)
CPPonset_Hemifield<-update(CPPonset_Group, .~. + Hemifield)
CPPonset_HemifieldbyGroup<-update(CPPonset_Hemifield, .~. + Hemifield:Group)
anova(CPPonset_random_intercepts_only, CPPonset_Group, CPPonset_Hemifield, CPPonset_HemifieldbyGroup)

# try glmer() with family = Gamma(link = log) 
CPPonset_random_intercepts_only<-glmer(CPPonset ~ 1 + (1 | ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2, family = Gamma(link = log), na.action = na.omit)
CPPonset_Group<-update(CPPonset_random_intercepts_only, .~. + Group)
CPPonset_Hemifield<-update(CPPonset_Group, .~. + Hemifield)
CPPonset_HemifieldbyGroup<-update(CPPonset_Hemifield, .~. + Hemifield:Group)
anova(CPPonset_random_intercepts_only, CPPonset_Group, CPPonset_Hemifield, CPPonset_HemifieldbyGroup)

#add 100 

source("summarySE.R") 
source("summarySEwithin.R") #function to calculate Std.Er of mean
source("normDataWithin.R")
plotdata <- summarySEwithin(data2, measurevar="CPPonset", withinvars=c("Hemifield"), betweenvars="Group", idvar="ID")
ggplot(plotdata, aes(x=Group, y=CPPonset, fill=Hemifield)) +
    geom_bar(position=position_dodge(.9), colour="Black", stat="identity") + 
    geom_errorbar(position=position_dodge(.9), width=.3, aes(ymin=CPPonset-se, ymax=CPPonset+se)) + #can change "se" to "ci" if I want to use 95%ci 
    geom_hline(yintercept=0) +  coord_cartesian(ylim = c(0, 400)) +
    xlab("Hemifield") + ylab("CPPonset (ms)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black")) 


#Kick out outliers
#####Z-score each participant's CPPonset inside Hemifield####
data2$IDbyHemifield<-interaction(data2$ID, data2$Hemifield) 
#calculate mean and sd 
m <- tapply(data2$CPPonset,data2$IDbyHemifield,mean,na.rm=T)
s <- sqrt(tapply(data2$CPPonset,data2$IDbyHemifield,var,na.rm=T))
#calculate CPPonset.Z and save it inside data2.frame
data2$CPPonset.Z <- (data2$CPPonset-m[data2$IDbyHemifield])/s[data2$IDbyHemifield]
#check that Z scores have mean=0 and std=1 
CPPonset.Z_checker <- ddply(data2, c("ID", "Hemifield"), summarise,
                                     N    = length(CPPonset.Z),
                                     mean = round(mean(CPPonset.Z)),
                                     sd   = sd(CPPonset.Z ),
                                     se   = sd / sqrt(N) )
summary(CPPonset.Z_checker)
##Remove trials where absolute CPPonset.Z>3 (i.e. remove outlier CPPonsets)
data2<-data2[!abs(data2$CPPonset.Z)>3,]


```


