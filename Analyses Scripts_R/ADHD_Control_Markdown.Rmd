---
title: "ADHD_Control_Markdown"
author: "Daniel Newman"
output:
  html_document:
    fig_width: 8
    keep_md: yes
  word_document: default
---


```{r Load and Pre-Process the single trial Data, echo=FALSE, include=FALSE}

####Which computer/directory is this being run on?
location<-"Monash"
# location<-"DansLaptop"

if (location=="Monash") {
    setwd(("C:/GitHub/ADHDvsControls/Analyses Scripts_R"))
} else if (location=="DansLaptop") {
    setwd(("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_R"))
} else setwd(("~"))



### Install/load required packages
#List of R packages required for this analysis:
required_packages <- c("aod", "psych", "ggplot2", "tidyr", "stringr", "lubridate", "readxl","knitr",
                       "readr", "rmarkdown", "png", "lme4", "ez", "multcomp","zoo", "dplyr")
#Install required_packages:
new.packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
#Load required_packages:
lapply(required_packages, require, character.only = TRUE)






###### Import single trial data:
if (location=="Monash") {
data <- read.csv("C:/GitHub/ADHDvsControls/Analyses Scripts_Matlab/master_matrix_R.csv", header=FALSE)
} else if (location=="DansLaptop") {
data <- read.csv("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_Matlab/master_matrix_R.csv", header=FALSE)
} else setwd(("~"))
#Import IDs:
if (location=="Monash") {
ID <- read.table("C:/GitHub/ADHDvsControls/Analyses Scripts_Matlab/ID_vector.csv", quote="\"")
} else if (location=="DansLaptop") {
ID <- read.table("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_Matlab/ID_vector.csv", quote="\"")
} else setwd(("~"))

data$ID<-data[,1]
#Replace the participant numbers with IDs:
data[,1]<-ID[,1]
#Remove the seperate ID vector now it has been included into data dataframe
rm(ID)
drops <- c("ID")
data<-data[,!(names(data) %in% drops)]



###### Import data_ParticipantLevel:
if (location=="Monash") {
participant_level <- read.csv("C:/GitHub/ADHDvsControls/Analyses Scripts_Matlab/participant_level_matrix.csv", header=FALSE)
} else if (location=="DansLaptop") {
participant_level <- read.csv("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_Matlab/participant_level_matrix.csv", header=FALSE)
} else setwd(("~"))
#remove the RT measures that were calculated from ERP script - better to extract/collapse RT from the single-trial data so RT trials are not influenced by EEG artifacts
participant_level<-participant_level[,-c(1:4)]

#Import IDs:
if (location=="Monash") {
ID <- read.table("C:/GitHub/ADHDvsControls/Analyses Scripts_Matlab/IDs.csv", quote="\"")
} else if (location=="DansLaptop") {
ID <- read.csv("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_Matlab/IDs.csv", header=F)
} else setwd(("~"))
ID<-plyr::rename(ID,c("V1"="ID"))
participant_level$ID<-ID$ID
rm(ID)
# drops <- c("ID")
# participant_level<-participant_level[,!(names(participant_level) %in% drops)]

#import demographic data
if (location=="Monash") {
Demographics<-read.csv("C:/GitHub/ADHDvsControls/Analyses Scripts_R/ADHD_Control_Demographics_etc.csv", header=T)
} else if (location=="DansLaptop") {
Demographics<-read.csv("C:/Users/Dan/Documents/GitHub/ADHDvsControls/Analyses Scripts_R/ADHD_Control_Demographics_etc.csv", header=T)
} else setwd(("~"))

#Remove all the previous Demographic measures ("_A") 
#we are only interested in the Demographic measures taken 
#when the RT and EEG data was collected ("_B")
Demographics <- Demographics %>% select(-ends_with("_A"))

#Rename data columns:
data<- data %>% #Rename data columns:
    rename(., 
            ID=V1,
            Group=V2,
            TotalTrialNumber=V3,
            Trial=V4,
            ITI=V5,
            Hemifield=V6,
            Accuracy=V7,
            RT=V8,
            Blinkneg500to0=V9,
            Blinkneg100_100PR=V10,
            Blinkneg100_450=V11,
            LeftFixBreakneg500_0=V12,
            LeftFixBreakneg100_100PR=V13,
            LeftFixBreakneg100_450=V14,
            RightFixBreakneg500_0=V15,
           RightFixBreakneg100_100PR=V16,
           RightFixBreakneg100_450=V17,
           BothFixBreakneg500_0=V18,
           BothFixBreakneg100_100PR=V19,
           BothFixBreakneg100_450=V20,
           Art_neg500_0=V21,
           Art_neg100_100PR=V22,
		   BLANK=V23,
		   RejectedTrial=V24,
		   Art_neg100_450=V25,
		   PreAlphaPowerLH=V26,
		   PreAlphaPowerRH=V27,
		   PreAlphaAsym=V28,
		   PrePupilDiameter=V29,
		   N2c_GA=V30,
		   N2i_GA=V31,
		   RespLockedCPPSlope=V32,
		   StimLockedCPPSlope=V33,
		   N2cPeakLatency=V34,
		   CPPHalfPeakLatency=V35,
		   N2c_PA=V36,
		   N2i_PA=V37,
		   PostAlphaPowerLH=V38,
		   PostAlphaPowerRH=V39) %>% #next make the required columns into factors:
            mutate_each_(funs(factor), c("Group", "ITI", "Hemifield", "Accuracy")) %>% #next re-class required vectors into Logicals:
            mutate_at(vars(starts_with("Art_")), funs(as.logical)) %>% 
            mutate_at(vars(contains("FixBreak")), funs(as.logical)) %>% 
            mutate_at(vars(contains("Blink")), funs(as.logical)) %>% 
            mutate_at(vars(starts_with("RejectedTrial")), funs(as.logical)) %>%#next Rename factor Levels:
            mutate(Hemifield = ifelse(Hemifield==1, "Left", "Right"), 
           Accuracy= ifelse(Accuracy==1, "Hit", "Miss"),
            Group = ifelse(Group==1, "ADHD", "Control"))
#NOTE: FOR N2c/i,  the _GA or _PA suffix indicates whether N2c/i is measured with a measurement window based
#on Grand average (GA) peak N2c/i latency,  or based on Participant level average (PA) peak N2c/i latency
             

#Order any ordinal factors (may have to do this the "trail" or later too) 
# by defult R uses polynomial contrasts for ordered factors, I'd rather treat light as unordered and to "treatment" contrasts, i.e. Low vs Med, Low vs High
data$ITI <- ordered(data$ITI)  


###############Data Cleaning For Single Trial Data######################
#Check number of Trials for each participant by running the function 'length', 
#on "data$RT" for each group, broken down by ID + Light
num_trials1 <- data %>% group_by(ID) %>% summarise( Trials = length(RT))
summary(num_trials1$Trials)


##################Accuracy ##########################
Accuracy_checker <- data %>% 
    group_by(ID) %>% 
    summarise(Hits  = sum(Accuracy=="Hit"),
              Misses = sum(Accuracy=="Miss"),
              LeftFixBreak = sum(LeftFixBreakneg100_100PR),
              RightFixBreak = sum(RightFixBreakneg100_100PR)) %>%
    mutate(Total=Hits+Misses,
           Accuracy_Total= (Hits/Total)*100,
           LeftFixBreak_percent = LeftFixBreak/(Total/2)*100,
           RightFixBreak_percent = RightFixBreak/(Total/2)*100) 
summary(Accuracy_checker$Accuracy_Total)


#Accuracy by Hemifield 
Accuracy_checker_Hemifield <- data %>% 
    group_by(ID, Hemifield) %>% 
    summarise(Hits  = sum(Accuracy=="Hit"),
              Misses = sum(Accuracy=="Miss")) %>%
    mutate(Total=Hits+Misses,
           Accuracy_Total= (Hits/Total)*100) %>%
    select(ID, Hemifield, Accuracy_Total) %>%
    spread(Hemifield, Accuracy_Total) %>%
    rename(Accuracy_Left = Left,
           Accuracy_Right = Right) %>%
    mutate(Accuracy_Asym =  #Negitive is better accuracy for left targets, positive is better accuracy for right targets:
               (Accuracy_Right-Accuracy_Left)/(Accuracy_Right+Accuracy_Left))


#merge Accuracy by hemifield in with in overall accuracy
Accuracy_checker <- merge(Accuracy_checker, Accuracy_checker_Hemifield, by.x = "ID", by.y = "ID")
rm(Accuracy_checker_Hemifield)

#Remove RejectedTrial (with eeg trigger conflicts)
#trials where RT longer than 1500ms (i.e. after target finished)
#or RT faster than 150ms (i.e. too fast must be false alarm)
data<-filter(data, RT<2000, RT>200, !-RejectedTrial)

############################################ Log transform:
data$log_RT<-log(data$RT) #log
data$sqrt_RT<-sqrt(data$RT)

ggplot(data, aes(RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)
ggplot(data, aes(log_RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)
ggplot(data, aes(sqrt_RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)

#####Z-score each participant's log_RT data ####
data$IDbyITIbyHemifield<-interaction(data$ID, data$ITI, data$Hemifield)
#calculate mean and sd 
m <- tapply(data$log_RT,data$IDbyITIbyHemifield,mean, na.rm = T)
s <- tapply(data$log_RT,data$IDbyITIbyHemifield,sd, na.rm = T)
#calculate log_RT.Z and save it inside data.frame
data$log_RT.Z <- (data$log_RT-m[data$IDbyITIbyHemifield])/s[data$IDbyITIbyHemifield]
#Remove trials where absolute log_RT.Z>3 (i.e. remove outlier RTs)
data<-data[!abs(data$log_RT.Z)>3,]

#Remove trials where absolute log_RT.Z>3 (i.e. remove outlier RTs)
data<-data[!abs(data$log_RT.Z)>3,] #this is for individual trial 



#plot again after outlier removal:
ggplot(data, aes(RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)
ggplot(data, aes(log_RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)
ggplot(data, aes(sqrt_RT))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Group)


#Calculate alpha desynchronisation by subtracting Pre-target Alpha from post target alpha
data$AlphaDesyncRH<-(data$PreAlphaPowerRH)-(data$PostAlphaPowerRH)
data$AlphaDesyncLH<-data$PreAlphaPowerLH-data$PostAlphaPowerLH

# Make PostAlpha contralateral (PostAlpha_c) and -Ipsilateral (PostAlpha_i) variables:
A<-data$Hemifield=="Left"
#Absolute post target alpha
data$PostAlpha_c[A]<-data$PostAlphaPowerRH[A]
data$PostAlpha_c[!A]<-data$PostAlphaPowerLH[!A]
data$PostAlpha_i[!A]<-data$PostAlphaPowerRH[!A]
data$PostAlpha_i[A]<-data$PostAlphaPowerLH[A]

#Post target Alpha desynchronisation 
data$AlphaDesync_c[A]<-data$AlphaDesyncRH[A]
data$AlphaDesync_c[!A]<-data$AlphaDesyncLH[!A]
data$AlphaDesync_i[!A]<-data$AlphaDesyncRH[!A]
data$AlphaDesync_i[A]<-data$AlphaDesyncLH[A]

rm(A)




#################################################################################################################################
#################################################################################################################################
#################################################################################################################################
#################################################################################################################################

#Rename participant_level columns of participant_level:
participant_level<- participant_level %>% #Rename data columns:
                        rename(., 
                                ValidPreAlphaTrials=V5,
                                ValidN2TrialsTrials=V6,
                                ValidCPPTrials=V7,
                                PreAlpha_LeftHemi=V8,
                                PreAlpha_RightHemi=V9,
                                N2c_LeftTarget_GA=V10,
                                N2c_RightTarget_GA=V11,
                                N2i_LeftTarget_GA=V12,
                                N2i_RightTarget_GA=V13,
                                AlphaDesync_LeftHemi_LeftTarget=V14,
                                AlphaDesync_LeftHemi_RightTarget=V15,
                                AlphaDesync_RightHemi_LeftTarget=V16,
                                AlphaDesync_RightHemi_RightTarget=V17,
                                CPPonset_LeftTarget=V18,
                                CPPonset_RightTarget=V19,
                                N2c_latency_LeftTarget=V20,
                                N2c_latency_RightTarget=V21,
                                N2i_latency_LeftTarget=V22,
                                N2i_latency_RightTarget=V23,
                                CPPslope_LeftTarget=V24,
                                CPPslope_RightTarget=V25,
							   FrontalNeg_slope_LeftTarget=V26,
							   FrontalNeg_slope_RightTarget=V27,
							   ADHD_Control=V28,
							   N2c_LeftTarget_PA=V29,
							   N2c_RightTarget_PA=V30,
							   N2i_LeftTarget_PA=V31, 
							   N2i_RightTarget_PA=V32) %>% ##next calculate the ERP asymmetry measures:
					    mutate(., 
                              N2c_Asym_GA = (N2c_LeftTarget_GA-N2c_RightTarget_GA)/(N2c_LeftTarget_GA+N2c_RightTarget_GA), 
                              N2i_Asym_GA = (N2i_LeftTarget_GA-N2i_RightTarget_GA)/(N2i_LeftTarget_GA+N2i_RightTarget_GA),
							  N2c_Asym_PA = (N2c_LeftTarget_PA-N2c_RightTarget_PA)/(N2c_LeftTarget_PA+N2c_RightTarget_PA), 
                              N2i_Asym_PA = (N2i_LeftTarget_PA-N2i_RightTarget_PA)/(N2i_LeftTarget_PA+N2i_RightTarget_PA),
							  CPPonset_Asym = (CPPonset_LeftTarget-CPPonset_RightTarget)/(CPPonset_LeftTarget+CPPonset_RightTarget),
                              CPPslope_Asym = (CPPslope_LeftTarget-CPPslope_RightTarget)/(CPPslope_LeftTarget+CPPslope_RightTarget),
							  N2c_latency_Asym = (N2c_latency_LeftTarget-N2c_latency_RightTarget)/(N2c_latency_LeftTarget+N2c_latency_RightTarget), 
                              N2i_latency_Asym =(N2i_latency_LeftTarget-N2i_latency_RightTarget)/(N2i_latency_LeftTarget+N2i_latency_RightTarget)) 
#NOTE: FOR N2c/i ,  the _GA or _PA suffix indicates whether N2c/i is measured with a measurement window based  
#on Grand average (GA) peak N2c/i latency ,  or based on Participant level average (PA) peak N2c/i latency

#Merge Demographics into participant_level:
participant_level <- merge(participant_level, Demographics, by.x = "ID", by.y = "ID")
rm(Demographics)

participant_level<- participant_level %>%
    					    mutate(., 
                              Group = ifelse(Group==1, "ADHD", "Control"),
							  Hand_SR_B= ifelse(Hand_SR_B==1, "Left", "Right"),
							  Gender= ifelse(Gender==1, "Male", "Female"),
							  DAT1_3UTR= ifelse(DAT1_3_Group==1, "non10repeat_homozygous", "10repeat_homozygous"),
							  DAT1_i8= ifelse(DAT1_i8_Group==1, "non6repeat_homozygous", "6repeat_homozygous")) %>%
                        mutate_each_(funs(factor), c("Group", "Gender", "Hand_SR_B", "DAT1_3_Group", "DAT1_i8_Group")) 

#Look at Column names:
colnames(participant_level)

#Rename the full scale IQ, Edinburgh Handedness scale, reading for simplicity 
participant_level$IQ<-participant_level$eFSIQ_B
participant_level$Handedness_Edinburgh<-participant_level$HQ_B
participant_level$Handedness_SelfReport<-participant_level$Hand_SR_B
participant_level$Reading <-participant_level$Read_Standard_B #WRAT Reading standard score (at time B)
participant_level$Age<-participant_level$Age_B

#add in accuracy
participant_level <- merge(participant_level, Accuracy_checker, by.x = "ID", by.y = "ID")


###Incorporate the demographic variables from participant_level into the single trial 'data' dataframe 
target<-select(participant_level, ID, IQ, Handedness_Edinburgh, Handedness_SelfReport, Reading, Age, Gender, DAT1_3UTR, DAT1_i8,
                      Accuracy_Asym, Accuracy_Total, LeftFixBreak_percent, RightFixBreak_percent)
data<-merge(data, target, by.x="ID", by.y = "ID")
rm(target)


#Collapse each participant's RT single trials to participant level
RT_collapsed<- data %>% 
            filter(!LeftFixBreakneg100_100PR, !RightFixBreakneg100_100PR) %>%
            group_by(ID, Hemifield) %>%
            summarise(RT=mean(RT)) %>% #next bring Target-Hemifield up into wide format:
            spread(Hemifield, RT) %>% #next rename
            rename(RT_Left=Left, RT_Right=Right) %>% # next Calculate RT asymmetry:
            mutate(RT_Asym=(RT_Left-RT_Right)/(RT_Left+RT_Right)) 
#Merge it in with the ERP measures
participant_level<-merge(participant_level, RT_collapsed, by.x = "ID", by.y = "ID") 


############## Participant exclusion ####################   
#Participant level
participant_level <- filter(participant_level, 
                            Handedness_SelfReport == "Left",
                            ValidCPPTrials > 50,
                            LeftFixBreak_percent <55,
                            RightFixBreak_percent <55,
                            ((Group=="ADHD" & CPRS_N_B >= 65) | (Group=="Control" & CPRS_N_B <= 60)))


######################################################################################

####Find outliers in the Participant level data (abs z-score >3)####
#################################################################
#Calculate Z scores inside measure_type type TO REMOVE OUTLIERS
#Z-score each participant's data inside measure_type ####
#calculate mean and sd 

#Transform it to long format
participant_level_long<-participant_level %>%
                    select(ID, Group, RT_Left, RT_Right, RT_Asym, 
                           PreAlpha_LeftHemi:N2i_latency_Asym) %>%
                    gather(measure_type, data, -ID, -Group) %>%
                    na.omit() %>%
                    mutate(Group_by_measure_type = interaction(.$Group, .$measure_type))  %>%
                    na.omit() 
    

m <- tapply(participant_level_long$data, participant_level_long$Group_by_measure_type, mean, na.rm = T)
s <- tapply(participant_level_long$data, participant_level_long$Group_by_measure_type, sd, na.rm = T)
 
#calculate data.Z and save it inside participant_level_long
participant_level_long$data.Z <- (participant_level_long$data- m[participant_level_long$Group_by_measure_type])/s[participant_level_long$Group_by_measure_type]

participant_level_long<-participant_level_long %>% na.omit()

###Remove trials where absolute data.Z>3 (i.e. remove outlier RTs)
# participant_level_long<-participant_level_long[!abs(participant_level_long$data.Z)>3,]

###Shift extream outliers back to +/- 3 standard deviations from the mean
# participant_level_long$data[participant_level_long$data.Z>3]<-m[participant_level_long$Group_by_measure_type][participant_level_long$data.Z>3] + 3*s[participant_level_long$Group_by_measure_type][participant_level_long$data.Z>3]
# participant_level_long$data[participant_level_long$data.Z<(-3)]<-m[participant_level_long$Group_by_measure_type][participant_level_long$data.Z<(-3)] - 3*s[participant_level_long$Group_by_measure_type][participant_level_long$data.Z<(-3)]


#change measure_type to factor class
participant_level_long$Group_by_measure_type<-as.factor(participant_level_long$Group_by_measure_type)

#Put it back into wide format so I can use lapply to do t-test on columns 
drops <- c("data.Z")
participant_level_long<-participant_level_long[ , !(names(participant_level_long) %in% drops)]


#Look for participant level outliers in RT and RT-asymmetry
#calculate RT_Asym.Z inside Group and save it 
m <- tapply(participant_level$RT_Asym,participant_level$Group,mean, na.rm = T)
s <- tapply(participant_level$RT_Asym,participant_level$Group,sd, na.rm = T)
participant_level$RT_Asym.Z <- (participant_level$RT_Asym-m[participant_level$Group])/s[participant_level$Group]

#calculate RT_Left.Z inside Group and save it 
m <- tapply(participant_level$RT_Left,participant_level$Group,mean, na.rm = T)
s <- tapply(participant_level$RT_Left,participant_level$Group,sd, na.rm = T)
participant_level$RT_Left.Z <- (participant_level$RT_Left-m[participant_level$Group])/s[participant_level$Group]

#calculate RT_Right.Z inside Group and save it 
m <- tapply(participant_level$RT_Right,participant_level$Group,mean, na.rm = T)
s <- tapply(participant_level$RT_Right,participant_level$Group,sd, na.rm = T)
participant_level$RT_Right.Z <- (participant_level$RT_Right-m[participant_level$Group])/s[participant_level$Group]


#Kick out RT_Asym outliers
participant_level <- filter(participant_level,
                            abs(RT_Asym.Z)<3)

#Single trial
data <-data[data$ID %in% participant_level$ID, ] 

#This ^ Excludes participants from the ADHD group due to clinical cuttoff CPRS_N_B >= 65
# AD69C', 'AD59C', 'AD27C', 'AD51C', 'AD98C'
#...and excludes  control participants due to clinical cuttoff CPRS_N_B CPRS_N_B <= 60
#'C14', 'C259' for filter_CPRS_N_B; 
#....and also excludes C194 because this participant only had less than 50 valid trials for EEG
#...and also excludes AD11C and AD99C because they are left handed
#.....and excludes AD72C since he broke fixation towards the Left on 95% of left target trials
#.... and C62 was a significant outlier (abs Z>3) for RT_Asym
######################################################


#Save the participant level file as SPSS data folr
# library(haven)
# write_sav(participant_level, file.path(getwd(), "participant_level_data.sav"))

```


#Are there significant Accuracy differences between ADHD and Controls?

```{r, echo=FALSE, warning=FALSE}
###Check for Accuracy outliers
min(participant_level$Accuracy_Total)
min(participant_level$Accuracy_Left)
min(participant_level$Accuracy_Right)

ggplot(participant_level, aes(Accuracy_Total))  + geom_histogram() + facet_wrap(~ Group)
ggplot(participant_level, aes(Accuracy_Left))  + geom_histogram() + facet_wrap(~ Group)
ggplot(participant_level, aes(Accuracy_Right))  + geom_histogram() + facet_wrap(~ Group)

############ Are there significant accuracy differences between ADHD and Controls? 
#Overall Accuracy by Group
log <- capture.output({
Accuracy_Group <- ezPerm(data = participant_level
                                  , dv = .(Accuracy_Total)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Overall Accuracy:")
print(Accuracy_Group);


#Left Target Accuracy by Group
log <- capture.output({
Accuracy_Left_Group <- ezPerm(data = participant_level
                                  , dv = .(Accuracy_Left)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Accuracy for left targets:")
print(Accuracy_Left_Group);


#Right Target Accuracy by Group
log <- capture.output({
Accuracy_Right_Group <- ezPerm(data = participant_level
                                  , dv = .(Accuracy_Right)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Accuracy for right targets:")
print(Accuracy_Right_Group);


#Accuracy Asym by Group
log <- capture.output({
Accuracy_Asym_Group <- ezPerm(data = participant_level
                                  , dv = .(Accuracy_Asym)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Accuracy Asym:")
print(Accuracy_Asym_Group);


##Accuracy by Group and Hemifield
#Reshape participant_level into long format for modeling with ezANOVA:
Perm_data<- participant_level %>%
    select(ID, Accuracy_Left, Accuracy_Right, Group) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)%>%
    mutate(Hemifield=factor(Hemifield)) %>%
    mutate(ID=factor(ID)) 


log <- capture.output({
   Accuracy_GroupbyHemifield <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , between = .(Group)
                          , perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on Accuracy:")
print(Accuracy_GroupbyHemifield);

```


#Are there significant Fixation breaks differences between ADHD and Controls?

```{r, echo=FALSE, warning=FALSE}

## LEFT FixBreak by Group
log <- capture.output({
LeftFixBreak_Group <- ezPerm(data = participant_level
                                  , dv = .(LeftFixBreak_percent)
                                  , wid = .(ID)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Leftward Fixation Breaks:")
print(LeftFixBreak_Group);

ggplot(participant_level, aes(LeftFixBreak_percent))  + geom_histogram() + facet_wrap(~ Group)


## Right FixBreak by Group
log <- capture.output({
RightFixBreak_Group <- ezPerm(data = participant_level
                             , dv = .(RightFixBreak_percent)
                             , wid = .(ID)
                             , between = .(Group)
                             , perms = 1000
)
})
print("Factorial Permutation test for the effect of Group on Rightward Fixation Breaks:")
print(RightFixBreak_Group);


```


#Run tests of normality on the participant_level RT, CPPonset, N2c, etc. measures 
```{r, test of normality, echo=FALSE, warning=FALSE}
options(scipen=99)
Normality_tests <-participant_level %>% 
                    select(contains("Left"), contains("Right"), 
                           -contains("Accuracy"), -contains("FixBreak"),
                           -contains(".Z"))  %>% 
                    gather() %>% 
                    group_by(key) %>%
                    do(ShapiroWilk_p_value= shapiro.test(.$value)[2],
                       Anderson_Darling_p_value = nortest::ad.test(.$value)[2], 
                       CramerVonMises_p_value = nortest::cvm.test(.$value)[2],
                       Shapiro_Francia_p_value = nortest::sf.test(.$value)[2],
                       Kolmogorov_Smirnov_p_value= nortest::lillie.test(.$value)[2]) %>% 
                    mutate(ShapiroWilk_p_value= unlist(ShapiroWilk_p_value),
                       Anderson_Darling_p_value = unlist(Anderson_Darling_p_value), 
                       CramerVonMises_p_value = unlist(CramerVonMises_p_value),
                       Shapiro_Francia_p_value = unlist(Shapiro_Francia_p_value),
                       Kolmogorov_Smirnov_p_value = unlist(Kolmogorov_Smirnov_p_value)) %>% 
                    mutate(average_p_value=(ShapiroWilk_p_value + 
                                                Anderson_Darling_p_value + 
                                                CramerVonMises_p_value + 
                                                Shapiro_Francia_p_value + 
                                                Kolmogorov_Smirnov_p_value)/5) %>% arrange(average_p_value)
kable(Normality_tests,
    format.args = list(big.mark = ","), digits=4,
      caption="Normality tests")
```

#Test the effect of Target Hemifield on RT, CPPonset, N2c, etc. using repeated measures ANOVA

##In cases where the assumption of normality was violated, a factorial permutation test for the effect of Target Hemifield was performed with 1000 permutations and the permuted p-value also reported
```{r, effect of Target Hemifield, echo=FALSE, warning=FALSE}
###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, RT_Left, RT_Right) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)

   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                        , dv = .(dv)
                        , wid = .(ID)
                        , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3)
print("Repeated Measures ANOVA  for the Group*Hemifield effect on RT:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Group, Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))


ggplot(ANOVA_data, aes(Hemifield, dv, colour = Hemifield))  +
          geom_violin() + 
    geom_boxplot(alpha=0.1) +  
    theme_bw () + 
    geom_point() +
    xlab("Target Hemifield") + ylab("Reaction Time (ms)") + 
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black")) +
     coord_flip() +
    facet_wrap(~Group)

# Density plot
ggplot(participant_level, aes(RT_Asym, fill=Group))  + geom_density(alpha=.4) +
    geom_vline(data=participant_level %>% 
                   group_by(Group) %>% 
                   summarise(RT_Asym.mean=mean(RT_Asym)), 
               aes(xintercept=RT_Asym.mean,  colour=Group),
               linetype="dashed", size=1)

###################################################################

ANOVA_data<- participant_level %>%
    select(ID,Group, CPPonset_LeftTarget, CPPonset_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)



Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on CPP Onset:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Group, Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))


#Permutation test:
Perm_data<- participant_level %>%
    select(ID,Group, CPPonset_LeftTarget, CPPonset_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)

log <- capture.output({
   Group_by_Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          ,between=Group, perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on CPP Onset:")
print(Group_by_Hemifield_Perm);

ggplot(ANOVA_data, aes(Hemifield, dv, colour = Hemifield))  +
          geom_violin() + 
    geom_boxplot(alpha=0.1) +  
    theme_bw () + 
    geom_point() +
    xlab("Target Hemifield") + ylab("CPP Onset (ms)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black"))+
     coord_flip() +
    facet_wrap(~Group)



###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, CPPslope_LeftTarget, CPPslope_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)



   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on CPP Slope:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Group, Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, N2i_latency_LeftTarget, N2i_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)


   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on N2i_latency:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Group, Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

#Permutation test:
Perm_data<- participant_level %>%
    select(ID,Group, N2i_latency_LeftTarget, N2i_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)

log <- capture.output({
   Group_by_Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          ,between=Group, perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on N2i_latency:")
print(Group_by_Hemifield_Perm);

###################################################################
ANOVA_data<- participant_level %>%
    select(ID, Group, N2i_LeftTarget_GA, N2i_RightTarget_GA) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)


   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on N2i Amplitude:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Group, Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, N2c_latency_LeftTarget, N2c_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)


   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on N2c_latency:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Group, Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

#Permutation test:
Perm_data<- participant_level %>%
    select(ID,Group, N2c_latency_LeftTarget, N2c_latency_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)

log <- capture.output({
   Group_by_Hemifield_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          ,between=Group, perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on N2c_latency:")
print(Group_by_Hemifield_Perm);

###################################################################
ANOVA_data<- participant_level %>%
    select(ID,Group, N2c_LeftTarget_GA, N2c_RightTarget_GA) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)


   Group_by_Hemifield_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the Group*Hemifield effect on N2c Amplitude:")
print(Group_by_Hemifield_ANOVA);

kable(ANOVA_data %>% group_by(Group, Hemifield) %>% summarise(mean=mean(dv),sd=sd(dv)))

###################################################################
#combine N2c and N2i into the one analysis and test for the TargetHemifield*Hemisphere interaction:
ANOVA_data<- participant_level %>%
    select(ID, Group, N2c_LeftTarget_PA, N2c_RightTarget_PA, N2i_LeftTarget_PA, N2i_RightTarget_PA) %>%
    na.omit() %>%
    gather(condition, dv, -ID, -Group) %>%
    mutate(Hemifield = replace(condition, condition=="N2c_LeftTarget_PA" | condition=="N2i_LeftTarget_PA", "Left")) %>%
    mutate(Hemifield = replace(Hemifield, condition=="N2c_RightTarget_PA" | condition=="N2i_RightTarget_PA", "Right")) %>%
    mutate(Hemisphere = replace(condition, condition=="N2i_LeftTarget_PA" | condition=="N2i_RightTarget_PA", "Ipsilateral")) %>%
    mutate(Hemisphere = replace(Hemisphere, condition=="N2c_LeftTarget_PA" | condition=="N2c_RightTarget_PA", "Contralateral")) %>%
    as.data.frame()


Hemifield_Hemisphere_ANOVA <- ezANOVA(data = ANOVA_data
                              , dv = .(dv)
                              , wid = .(ID)
                              , within = .(Hemifield, Hemisphere)
                                , within_covariates = NULL
                                , between = Group
                                , between_covariates = NULL
                                , observed = NULL
                                , type = 3);
print("Repeated Measures ANOVA for the effects of Hemifield*Hemisphere on N2_PA Amplitude:")
print(Hemifield_Hemisphere_ANOVA);


ANOVA_data<- participant_level %>%
    select(ID, Group, N2c_LeftTarget_GA, N2c_RightTarget_GA, N2i_LeftTarget_GA, N2i_RightTarget_GA) %>%
    na.omit() %>%
    gather(condition, dv, -ID, -Group) %>%
    mutate(Hemifield = replace(condition, condition=="N2c_LeftTarget_GA" | condition=="N2i_LeftTarget_GA", "Left")) %>%
    mutate(Hemifield = replace(Hemifield, condition=="N2c_RightTarget_GA" | condition=="N2i_RightTarget_GA", "Right")) %>%
    mutate(Hemisphere = replace(condition, condition=="N2i_LeftTarget_GA" | condition=="N2i_RightTarget_GA", "Ipsilateral")) %>%
    mutate(Hemisphere = replace(Hemisphere, condition=="N2c_LeftTarget_GA" | condition=="N2c_RightTarget_GA", "Contralateral")) %>%
    as.data.frame()


Hemifield_Hemisphere_ANOVA <- ezANOVA(data = ANOVA_data
                              , dv = .(dv)
                              , wid = .(ID)
                              , within = .(Hemifield, Hemisphere)
                                , within_covariates = NULL
                                , between = Group
                                , between_covariates = NULL
                                , observed = NULL
                                , type = 3);
print("Repeated Measures ANOVA for the effects of Hemifield*Hemisphere on N2_GA Amplitude:")
print(Hemifield_Hemisphere_ANOVA);

###################################################################


ANOVA_data<- participant_level %>%
    select(ID,Group, PreAlpha_LeftHemi, PreAlpha_RightHemi) %>%
    na.omit() %>%
    gather(Hemisphere, dv, -ID, -Group)


   Hemisphere_ANOVA <- ezANOVA(data = ANOVA_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemisphere)
                        , within_covariates = NULL
                        , between = Group
                        , between_covariates = NULL
                        , observed = NULL
                        , type = 3);
print("Repeated Measures ANOVA  for the effect of Hemisphere on Pre-target Alpha Power:")
print(Hemisphere_ANOVA);


kable(ANOVA_data %>% group_by(Group, Hemisphere) %>% summarise(mean=mean(dv),sd=sd(dv)))

Perm_data<- participant_level %>%
    select(ID,Group, PreAlpha_LeftHemi, PreAlpha_RightHemi) %>%
    na.omit() %>%
    gather(Hemisphere, dv, -ID, -Group)

log <- capture.output({
   Hemisphere_Perm <- ezPerm(data = Perm_data
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemisphere)
                          , between=Group, 
                          perms = 1000);
 })
print("Factorial Permutation test for the effect of Hemisphere on Pre-target Alpha Power:")
print(Hemisphere_Perm);


ggplot(ANOVA_data, aes(Hemisphere, dv, colour = Hemisphere))  +
    geom_violin() + 
    geom_boxplot(alpha=0.1) +  
    geom_point() +
    xlab("Hemisphere") + ylab("Alpha Power (uV)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12), 
          axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(face="bold", angle=0, size=12),
          panel.background = element_blank()) +
    guides(colour=FALSE) +
    scale_x_discrete(labels=c("Left", "Right")) +
    facet_wrap(~Group)


######################################################################
```

#Test the Group x Hemifield effect on single trial RTs:

```{r, echo=FALSE, warning=FALSE}
########################### Multi-level Models ########################## 
data2<-data[!data$LeftFixBreakneg100_100PR  &!data$RightFixBreakneg100_100PR,]

# RT_random_intercepts_only<-glmer(RT ~ 1 + (1 | Group/ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2, family = Gamma(link = log), na.action = na.omit)
RT_random_intercepts_only<-lmer(log(RT) ~ 1 + (1 | ID) +(1|ITI) + (1|Hemifield) + (1|Trial), data = data2, REML=FALSE, na.action = na.omit)
RT_Group<-update(RT_random_intercepts_only, .~. + Group)
RT_Hemifield<-update(RT_Group, .~. + Hemifield)
RT_HemifieldbyGroup<-update(RT_Hemifield, .~. + Hemifield:Group)
anova(RT_random_intercepts_only, RT_Group, RT_Hemifield, RT_HemifieldbyGroup)

RT_random_intercepts_only<-lmer(log(RT) ~ 1 + (Hemifield | ID) +(1|ITI) + (1|Trial), data = data2, REML=FALSE, na.action = na.omit)
RT_Group<-update(RT_random_intercepts_only, .~. + Group)
RT_Hemifield<-update(RT_Group, .~. + Hemifield)
RT_HemifieldbyGroup<-update(RT_Hemifield, .~. + Hemifield:Group)
anova(RT_random_intercepts_only, RT_Group, RT_Hemifield, RT_HemifieldbyGroup)



##Try Group * Hemifield interaction on RT (rather than using RT-asym)
#So get participant level RT into long format so I can run permutated mixed model anova 
Perm_data<- participant_level %>%
    select(ID,Group, RT_Left, RT_Right, Group) %>%
    na.omit() %>%
    gather(Hemifield, dv, -ID, -Group)%>%
    mutate(Hemifield=factor(Hemifield)) %>%
    mutate(ID=factor(ID)) 

log <- capture.output({
   Group_by_Hemifield_Perm <- ezPerm(data = as.data.frame(Perm_data)
                          , dv = .(dv)
                          , wid = .(ID)
                          , within = .(Hemifield)
                          , between = .(Group)
                          ,perms = 1000);
 })
print("Factorial Permutation test for the Group*Hemifield effect on RT:")
print(Group_by_Hemifield_Perm);



```



**So controls have significantly faster RTs overall**


###Controls have significant pseudoneglect (i.e. faster RTs to left hemifield targets), and ADHD do not

**Lets plot this:**

```{r, echo=FALSE, warning=FALSE}


detach("package:dplyr", unload=TRUE) #Detach dplyr as functions below use plyr
source("summarySE.R") 
source("summarySEwithin.R") #function to calculate Std.Er of mean
source("normDataWithin.R")
plotdata <- summarySEwithin(data2, measurevar="RT", withinvars=c("Hemifield"), betweenvars="Group", idvar="ID")
lapply(required_packages, require, character.only = TRUE) # re-load all librarys no that I'm finished with dlyr
ggplot(plotdata, aes(x=Group, y=RT, fill=Hemifield)) +
    geom_bar(position=position_dodge(.9), colour="Black", stat="identity") + 
    geom_errorbar(position=position_dodge(.9), width=.3, aes(ymin=RT-ci, ymax=RT+ci)) + #can change "se" to "ci" if I want to use 95%ci instead
    geom_hline(yintercept=0) +  coord_cartesian(ylim = c(700, 900)) +
    xlab("Hemifield") + ylab("RT (ms)") +
    theme(axis.title.x = element_text(face="bold", size=12),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=12),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=11, face="bold")) +
    theme(legend.text = element_text(size = 11, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black")) 


#look at it over time-on-task
ggplot(data2, aes(Trial, RT, fill=Hemifield,colour=Hemifield)) +
    stat_smooth(method="glm",level = 0.95,size=1) + 
    theme(axis.title.x = element_text(face="bold", size=14),
          axis.text.x  = element_text(face="bold", angle=0,  size=12)) +
    theme(axis.title.y = element_text(face="bold", size=14),
          axis.text.y  = element_text(angle=0, vjust=0.5, size=12)) +
    theme(legend.title = element_text(size=14, face="bold")) +
    theme(legend.text = element_text(size = 12, face = "bold")) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          panel.background = element_blank(), axis.line = element_line(colour = "black"))  + 
    facet_wrap(~ Group)


```


#Single trial N2 Amplitude 

###N2c/i measurement window (100ms) was centred on peak amplitude of each INDIVIDUAL PARTICIANT's AVERAGE N2c/i waveforms:

```{r, echo=FALSE, message=FALSE}
# 
ANOVA_data<- participant_level %>%
    select(ID, Group, N2c_LeftTarget_PA, N2c_RightTarget_PA, N2i_LeftTarget_PA, N2i_RightTarget_PA) %>%
    na.omit() %>%
    gather(condition, dv, -ID, -Group) %>%
    mutate(Hemifield = replace(condition, condition=="N2c_LeftTarget_PA" | condition=="N2i_LeftTarget_PA", "Left")) %>%
    mutate(Hemifield = replace(Hemifield, condition=="N2c_RightTarget_PA" | condition=="N2i_RightTarget_PA", "Right")) %>%
    mutate(Hemisphere = replace(condition, condition=="N2i_LeftTarget_PA" | condition=="N2i_RightTarget_PA", "Ipsilateral")) %>%
    mutate(Hemisphere = replace(Hemisphere, condition=="N2c_LeftTarget_PA" | condition=="N2c_RightTarget_PA", "Contralateral")) %>%
    as.data.frame()

log <- capture.output({
N2amp_perm <- ezPerm(data = ANOVA_data
                                  , dv = .(dv)
                                  , wid = .(ID)
                                  , within = .(Hemifield, Hemisphere)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the Hemifield*Hemisphere*Group on the N2_PA:")
print(N2amp_perm);


ANOVA_data<- participant_level %>%
    select(ID, Group, N2c_LeftTarget_GA, N2c_RightTarget_GA, N2i_LeftTarget_GA, N2i_RightTarget_GA) %>%
    na.omit() %>%
    gather(condition, dv, -ID, -Group) %>%
    mutate(Hemifield = replace(condition, condition=="N2c_LeftTarget_GA" | condition=="N2i_LeftTarget_GA", "Left")) %>%
    mutate(Hemifield = replace(Hemifield, condition=="N2c_RightTarget_GA" | condition=="N2i_RightTarget_GA", "Right")) %>%
    mutate(Hemisphere = replace(condition, condition=="N2i_LeftTarget_GA" | condition=="N2i_RightTarget_GA", "Ipsilateral")) %>%
    mutate(Hemisphere = replace(Hemisphere, condition=="N2c_LeftTarget_GA" | condition=="N2c_RightTarget_GA", "Contralateral")) %>%
    as.data.frame()

log <- capture.output({
N2amp_perm <- ezPerm(data = ANOVA_data
                                  , dv = .(dv)
                                  , wid = .(ID)
                                  , within = .(Hemifield, Hemisphere)
                                  , between = .(Group)
                                  , perms = 1000
)
})
print("Factorial Permutation test for the Hemifield*Hemisphere*Group on the N2_GA:")
print(N2amp_perm);



#Make Hemisphere a factor:
DF<-select(data, ID, ITI, Hemifield, N2c_PA, N2i_PA, Trial, Blinkneg100_450, LeftFixBreakneg100_450, RightFixBreakneg100_450, Art_neg100_450, 
                  BothFixBreakneg100_450, Group, Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh)

DF$contralateral<-rep("contralateral",length(DF[,1]))
DF$ipsilateral<-rep("ipsilateral",length(DF[,1]))               
DF_contralateral<-subset(DF, select=c(ID, ITI, Hemifield,N2c_PA,contralateral,Trial,Blinkneg100_450, 
                                      LeftFixBreakneg100_450, RightFixBreakneg100_450, Art_neg100_450, BothFixBreakneg100_450,Group,
                                      Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh))
DF_ipsilateral<-subset(DF, select=c(ID, ITI, Hemifield,N2i_PA,ipsilateral,Trial,Blinkneg100_450, 
                                    LeftFixBreakneg100_450, RightFixBreakneg100_450, Art_neg100_450, BothFixBreakneg100_450,Group,
                                    Age, Reading, Gender, Handedness_SelfReport, Handedness_Edinburgh))

names(DF_contralateral)[names(DF_contralateral)=="contralateral"] <- "Hemisphere"
names(DF_ipsilateral)[names(DF_ipsilateral)=="ipsilateral"] <- "Hemisphere"
names(DF_contralateral)[names(DF_contralateral)=="N2c_PA"] <- "N2"
names(DF_ipsilateral)[names(DF_ipsilateral)=="N2i_PA"] <- "N2"
DF<-rbind(DF_contralateral,DF_ipsilateral)
rm(DF_contralateral,DF_ipsilateral)
DF$Hemisphere <- factor(DF$Hemisphere)

DF<-DF[!DF$Blinkneg100_450 & !DF$LeftFixBreakneg100_450 & !DF$RightFixBreakneg100_450 & !DF$Art_neg100_450 & !DF$BothFixBreakneg100_450, ]


DF$IDbyHemifieldbyITIbyHemispherebyHemisphere<-interaction(DF$ID, DF$Hemifield, DF$ITI, DF$Hemisphere)
#calculate mean and sd 
m <- tapply(DF$N2,DF$IDbyHemifieldbyITIbyHemisphere,mean)
s <- sqrt(tapply(DF$N2,DF$IDbyHemifieldbyITIbyHemisphere,var))
#calculate N2.Z and save it inside data.frame
DF$N2.Z <- (DF$N2-m[DF$IDbyHemifieldbyITIbyHemisphere])/s[DF$IDbyHemifieldbyITIbyHemisphere]
#check that Z scores have mean=0 and std=1 
N2.Z_checker <- ddply(DF, c("ID", "Hemifield", "ITI", "Hemisphere"), summarise,
                      N    = length(N2.Z ),
                      mean = round(mean(N2.Z )),
                      sd   = sd(N2.Z ),
                      se   = sd / sqrt(N))

##Remove trials where absolute N2.Z>3 (i.e. remove outlier N2s)
DF<-DF[!abs(DF$N2.Z)>3,]

# hist_N2<-ggplot(DF, aes(N2))  + geom_histogram(aes(y=..count..), colour="black", fill="white") 
# hist_N2 + facet_wrap(~ ID)
# hist(DF$N2)

###Run the mixed model  
N2_random_intercepts_only<-lmer(N2 ~ 1 + (1 | ID/Hemisphere) +(1|ITI) + (1|Hemifield) + (1|Trial), data = DF, REML=FALSE, na.action = na.omit)
N2_Group<-update(N2_random_intercepts_only, .~. + Group)
N2_Hemifield<-update(N2_Group, .~. + Hemifield)
N2_Hemisphere<-update(N2_Hemifield, .~. + Hemisphere)
N2_HemifieldbyGroup<-update(N2_Hemisphere, .~. + Hemifield:Group)
N2_HemispherebyGroup<-update(N2_HemifieldbyGroup, .~. + Hemisphere:Group)
N2_HemifieldbyHemisphere<-update(N2_HemispherebyGroup, .~. + Hemisphere:Hemifield)
N2_HemifieldbyGroupbyHemisphere<-update(N2_HemifieldbyHemisphere, .~. + Hemifield:Group:Hemisphere)
anova(N2_random_intercepts_only, N2_Group, N2_Hemifield, N2_Hemisphere, N2_HemifieldbyGroup, N2_HemispherebyGroup, N2_HemifieldbyHemisphere, N2_HemifieldbyGroupbyHemisphere)



N2_random_effects_only<-lmer(N2 ~ 1 + (Hemifield | ID/Hemisphere) +(1|ITI) + (1|Trial), data = DF, REML=FALSE, na.action = na.omit)
N2_Group<-update(N2_random_effects_only, .~. + Group)
N2_Hemifield<-update(N2_Group, .~. + Hemifield)
N2_Hemisphere<-update(N2_Hemifield, .~. + Hemisphere)
N2_HemifieldbyGroup<-update(N2_Hemisphere, .~. + Hemifield:Group)
N2_HemispherebyGroup<-update(N2_HemifieldbyGroup, .~. + Hemisphere:Group)
N2_HemifieldbyHemisphere<-update(N2_HemispherebyGroup, .~. + Hemisphere:Hemifield)
N2_HemifieldbyGroupbyHemisphere<-update(N2_HemifieldbyHemisphere, .~. + Hemifield:Group:Hemisphere)
anova(N2_random_effects_only, N2_Group, N2_Hemifield, N2_Hemisphere, N2_HemifieldbyGroup, N2_HemispherebyGroup, N2_HemifieldbyHemisphere, N2_HemifieldbyGroupbyHemisphere)


#############################################################################################################
############################################################################################################
```

###So there is a significant Group x Hemifield x Hemisphere


#CPP onset 

###CPP onset was measured on a participant level (rather than on a single trial level) using the same method as Ger's Current Biology paper

```{r, echo=FALSE, message=FALSE}
#Reshape participant_level into long format for modeling with lmw4:
CPPonset_participant_level_long<- participant_level %>%
    select(ID, Group, CPPonset_LeftTarget, CPPonset_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, CPPonset, -ID, -Group)

# # #Check which participant have invalid CPPonset
CPPonset_participant_level_long[CPPonset_participant_level_long$CPPonset==0,]
#Remove any participants with CPP onsets of zero as they are not valid
CPPonset_participant_level_long<-CPPonset_participant_level_long[CPPonset_participant_level_long$CPPonset!=0,]

ezANOVA(
    data = CPPonset_participant_level_long
    , dv = .(CPPonset)
    , wid = .(ID)
    , within = .(Hemifield)
    , within_full = .(Hemifield)
    , between = (Group)
    , type = 3
    , detailed = F
)


##Test the Hemifield_By_Group effect in CPP onset
CPPonset_random_intercepts_only<-lmer(CPPonset ~ 1 + (1 | Group/ID) +(1|Hemifield), data = CPPonset_participant_level_long, REML=FALSE, na.action = na.omit)
CPPonset_Hemifield<-update(CPPonset_random_intercepts_only, .~. + Hemifield)
CPPonset_Group<-update(CPPonset_Hemifield, .~. + Group)
CPPonset_Hemifield_By_Group<-update(CPPonset_Group, .~. + Hemifield*Group)
anova(CPPonset_random_intercepts_only, CPPonset_Hemifield, CPPonset_Group, CPPonset_Hemifield_By_Group)

```

###So there is a significant Group x Hemifield effect for CPP onset


#Resp-locked CPP slope analysis (measured on participant level waveforms, not single-trial)

```{r, echo=FALSE, message=FALSE}
CPPslope_participant_level_long<- participant_level %>%
    select(ID, Group, CPPslope_LeftTarget, CPPslope_RightTarget) %>%
    na.omit() %>%
    gather(Hemifield, CPPslope, -ID, -Group)


#Find CPPslope Outliers 
CPPslope_participant_level_long$CPPslope.Z<-scale(CPPslope_participant_level_long$CPPslope)
#Check which participants have outlier CPPslopes
CPPslope_participant_level_long[!abs(CPPslope_participant_level_long$CPPslope.Z)<3,]
#Remove CPPslope Outliers 
CPPslope_participant_level_long<-CPPslope_participant_level_long[abs(CPPslope_participant_level_long$CPPslope.Z)<3,]

# #Histogram of participant's CPPslope scores by group and Hemifield 
# CPPslope_participant_level_long$Hemifield_By_Group<-interaction(CPPslope_participant_level_long$Hemifield, CPPslope_participant_level_long$Group)
# ggplot(CPPslope_participant_level_long, aes(CPPslope))  + geom_histogram(aes(y=..count..), colour="black", fill="white") + facet_wrap(~ Hemifield_By_Group)



CPPslope_random_intercepts_only<-lmer(CPPslope ~ 1 + (1 | Group/ID) +(1|Hemifield), data = CPPslope_participant_level_long, REML=FALSE, na.action = na.omit)
CPPslope_Hemifield<-update(CPPslope_random_intercepts_only, .~. + Hemifield)
CPPslope_Group<-update(CPPslope_Hemifield, .~. + Group)
CPPslope_Hemifield_By_Group<-update(CPPslope_Group, .~. + Hemifield*Group)
anova(CPPslope_random_intercepts_only, CPPslope_Hemifield, CPPslope_Group, CPPslope_Hemifield_By_Group)


```

```{r, echo=FALSE, message=FALSE, include=FALSE}
##Check assumptions for  model by plotting residuals:
residuals_CPPslope_Hemifield_By_Group=residuals(CPPslope_Hemifield_By_Group)
plot(residuals_CPPslope_Hemifield_By_Group)
qqnorm(residuals_CPPslope_Hemifield_By_Group)
qqline(residuals_CPPslope_Hemifield_By_Group)
hist(residuals_CPPslope_Hemifield_By_Group)


```


###So there is no differences in response-locked CPP slope between ADHD and Controls 



```{r}

ggplot(participant_level, aes(x=Reading, y=CPPonset_Asym, colour=Group)) +
        geom_point(shape=1, size=2) +    
        geom_smooth(method=lm, se=FALSE) + # Add linear regression line # Don't add shaded confidence region
        xlab("Reading Score") + ylab("CPP-onset Asymmetry") +
        theme(axis.title.x = element_text(face="bold", size=14),
              axis.text.x  = element_text(face="bold", angle=0,  size=14), #element_text(face="bold", angle=0,  size=14),
              axis.title.y = element_text(face="bold", size=14),
              axis.text.y  = element_text(face="bold", angle=0, size=14),
              panel.background = element_blank()) +
        geom_hline(yintercept=0, alpha = 0.4)


ggplot(participant_level, aes(x=Spell_Standard_B, y=CPPonset_Asym, colour=Group)) +
        geom_point(shape=1, size=2) +    
        geom_smooth(method=lm, se=FALSE) + # Add linear regression line # Don't add shaded confidence region
        xlab("Spelling Score") + ylab("CPP Onset Asymmetry") +
        theme(axis.title.x = element_text(face="bold", size=14),
              axis.text.x  = element_text(face="bold", angle=0,  size=14), #element_text(face="bold", angle=0,  size=14),
              axis.title.y = element_text(face="bold", size=14),
              axis.text.y  = element_text(face="bold", angle=0, size=14),
              panel.background = element_blank()) +
        geom_hline(yintercept=0, alpha = 0.4)


ggplot(participant_level, aes(x=Reading, y=RT_Asym, colour=Group)) +
        geom_point(shape=1, size=2) +    
        geom_smooth(method=lm, se=FALSE) + # Add linear regression line # Don't add shaded confidence region
        xlab("Reading Score") + ylab("RT Asymmetry") +
        theme(axis.title.x = element_text(face="bold", size=14),
              axis.text.x  = element_text(face="bold", angle=0,  size=14), #element_text(face="bold", angle=0,  size=14),
              axis.title.y = element_text(face="bold", size=14),
              axis.text.y  = element_text(face="bold", angle=0, size=14),
              panel.background = element_blank()) +
        geom_hline(yintercept=0, alpha = 0.4)


ggplot(participant_level, aes(x=Reading, y=Accuracy_Asym, colour=Group)) +
        geom_point(shape=1, size=2) +    
        geom_smooth(method=lm, se=FALSE) + # Add linear regression line # Don't add shaded confidence region
        xlab("Reading Score") + ylab("Accuracy Asymmetry") +
        theme(axis.title.x = element_text(face="bold", size=14),
              axis.text.x  = element_text(face="bold", angle=0,  size=14), #element_text(face="bold", angle=0,  size=14),
              axis.title.y = element_text(face="bold", size=14),
              axis.text.y  = element_text(face="bold", angle=0, size=14),
              panel.background = element_blank()) +
        geom_hline(yintercept=0, alpha = 0.4)


ggplot(participant_level, aes(x=RT_Asym, y=Accuracy_Asym, colour=Group)) +
        geom_point(shape=1, size=2) +    
        geom_smooth(method=lm, se=FALSE) + # Add linear regression line # Don't add shaded confidence region
        xlab("RT Asymmetry") + ylab("Accuracy Asymmetry") +
        theme(axis.title.x = element_text(face="bold", size=14),
              axis.text.x  = element_text(face="bold", angle=0,  size=14), #element_text(face="bold", angle=0,  size=14),
              axis.title.y = element_text(face="bold", size=14),
              axis.text.y  = element_text(face="bold", angle=0, size=14),
              panel.background = element_blank()) + 
        geom_hline(yintercept=0, alpha = 0.4) + 
        geom_vline(xintercept=0, alpha = 0.4)  #add black likes at 0 on x and y axis 




ggplot(participant_level, aes(x=Reading, y=N2c_LeftTarget_PA, colour=Group)) +
        geom_point(shape=1, size=2) +    
        geom_smooth(method=lm, se=FALSE) + # Add linear regression line # Don't add shaded confidence region
        xlab("Reading") + ylab("N2c_LeftTarget_PA Amplitude") +
        theme(axis.title.x = element_text(face="bold", size=14),
              axis.text.x  = element_text(face="bold", angle=0,  size=14), #element_text(face="bold", angle=0,  size=14),
              axis.title.y = element_text(face="bold", size=14),
              axis.text.y  = element_text(face="bold", angle=0, size=14),
              panel.background = element_blank()) 


ggplot(participant_level, aes(x=Spell_Standard_B, y=RT_Asym, colour=Group)) +
        geom_point(shape=1, size=2) +    
        geom_smooth(method=lm, se=FALSE) + # Add linear regression line # Don't add shaded confidence region
        xlab("Spelling Score") + ylab("RT Asymmetry") +
        theme(axis.title.x = element_text(face="bold", size=14),
              axis.text.x  = element_text(face="bold", angle=0,  size=14), #element_text(face="bold", angle=0,  size=14),
              axis.title.y = element_text(face="bold", size=14),
              axis.text.y  = element_text(face="bold", angle=0, size=14),
              panel.background = element_blank()) +
        geom_hline(yintercept=0, alpha = 0.4)



ggplot(participant_level, aes(x=Spell_Standard_B, y=Reading, colour=Group)) +
        geom_point(shape=1, size=2) +    
        geom_smooth(method=lm, se=FALSE) + # Add linear regression line # Don't add shaded confidence region
        xlab("Spelling Score") + ylab("Reading Score") +
        theme(axis.title.x = element_text(face="bold", size=14),
              axis.text.x  = element_text(face="bold", angle=0,  size=14), #element_text(face="bold", angle=0,  size=14),
              axis.title.y = element_text(face="bold", size=14),
              axis.text.y  = element_text(face="bold", angle=0, size=14),
              panel.background = element_blank())





ggplot(participant_level, aes(x=Reading, y=CPPonset_LeftTarget, colour=Group)) +
        geom_point(shape=1, size=2) +    
        geom_smooth(method=lm, se=FALSE) + # Add linear regression line # Don't add shaded confidence region
        xlab("Reading Score") + ylab("CPPonset (ms) LeftTarget") +
        theme(axis.title.x = element_text(face="bold", size=14),
              axis.text.x  = element_text(face="bold", angle=0,  size=14), #element_text(face="bold", angle=0,  size=14),
              axis.title.y = element_text(face="bold", size=14),
              axis.text.y  = element_text(face="bold", angle=0, size=14),
              panel.background = element_blank())


write_csv(participant_level, "participant_level.csv")
```





